

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>4) Monte Carlo Calibration Example &#8212; LISFLOOD - Río Aisén Use Case</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '4_Calibration_MC';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Excursus) Model Initialization Run" href="Excursus_Initialization.html" />
    <link rel="prev" title="3) Model Run" href="3_Run.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="readme.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/eu_banner.png" class="logo__image only-light" alt="LISFLOOD - Río Aisén Use Case - Home"/>
    <script>document.write(`<img src="_static/eu_banner.png" class="logo__image only-dark" alt="LISFLOOD - Río Aisén Use Case - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="readme.html">
                    LISFLOOD Use Case - Río Aisén, West Patagonia, Chile
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="0_Catchment.html"><strong>0) Catchment Overview</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="1_Preprocess.html"><strong>1) Preprocessing</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="2_Initialization.html"><strong>2) Model Initialization Run</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="3_Run.html"><strong>3) Model Run</strong></a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#"><strong>4) Monte Carlo Calibration Example</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="Excursus_Initialization.html"><strong>Excursus) Model Initialization Run</strong></a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/4_Calibration_MC.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>4) Monte Carlo Calibration Example</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parameters-and-their-bounds">Parameters and their bounds</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-general-configuration">4a) General Configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#b-actual-calibration">4b) Actual Calibration</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-parameter-bounds">Define Parameter Bounds</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#monte-carlo-sampling">Monte Carlo Sampling</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#c-compare-calibration-results">4c) Compare Calibration Results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#discharge-results">Discharge Results</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parameterizations-check">Parameterizations Check</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <p><img alt="EU Banner" src="_images/eu_banner.png" /></p>
<section class="tex2jax_ignore mathjax_ignore" id="monte-carlo-calibration-example">
<h1><strong>4) Monte Carlo Calibration Example</strong><a class="headerlink" href="#monte-carlo-calibration-example" title="Permalink to this heading">#</a></h1>
<hr class="docutils" />
<p>This use case intends to introduce the basic mechanics of the hydrological model <a class="reference external" href="https://github.com/ec-jrc/lisflood-code/">LISFLOOD</a>.</br>
This notebook demonstrates a simple Monte Carlo-based calibration for LISFLOOD. </br>
It generates <em>N</em> random parameter sets within defined bounds and runs the model for each set.</br>
In the official GloFAS and EFAS versions, the calibration is of course not done with a simple random sampling, but a genetic algorithm called DEAP is used (see <a class="reference external" href="https://www.jmlr.org/papers/volume13/fortin12a/fortin12a.pdf">Fortin et al., 2012</a>).</br></p>
<ul class="simple">
<li><p>Technical details of the calibration tool itself can be found <a class="reference external" href="https://github.com/ec-jrc/lisflood-calibration">here</a>.</p></li>
<li><p>EFAS-specific details, such as on parameters, skill and calibrated basins, you can get <a class="reference external" href="https://confluence.ecmwf.int/display/CEMS/EFAS+v5.0+-+Calibration+Methodology+and+Data">here</a>.</p></li>
<li><p>The GloFAS counterpart you find <a class="reference external" href="https://confluence.ecmwf.int/display/CEMS/GloFAS+v4+calibration+methodology+and+parameters">here</a>.</p></li>
</ul>
<hr class="docutils" />
<section id="parameters-and-their-bounds">
<h2>Parameters and their bounds<a class="headerlink" href="#parameters-and-their-bounds" title="Permalink to this heading">#</a></h2>
<p>In the following we will quickly provide an overview about LISFLOOD’s main calibration parameter.</br>
Main calibration parameters here refers to the fact that those are (some) of the ones used in the official GloFAS and EFAS calibration strategies.</br>
However, as users potentially have noticed already throughout the work with the settings files, there are plenty of other parameters that could be changed. <br>
In a snow-affected catchment like the Aisen, people might want more control than just relying on the degree-day factor (<em>SnowMeltCoef</em>) and for example also adjust the melt temperature itself, which is not touched in the official GloFAS and EFAS calibrations.</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>ParameterName</p></th>
<th class="head text-right"><p>MinValue</p></th>
<th class="head text-right"><p>MaxValue</p></th>
<th class="head text-right"><p>Default Value</p></th>
<th class="head text-right"><p>GloFAS Calib. Aisen</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>UpperZoneTimeConstant</p></td>
<td class="text-right"><p>0.01</p></td>
<td class="text-right"><p>40</p></td>
<td class="text-right"><p>10</p></td>
<td class="text-right"><p>9.0402</p></td>
</tr>
<tr class="row-odd"><td><p>LowerZoneTimeConstant</p></td>
<td class="text-right"><p>40</p></td>
<td class="text-right"><p>730</p></td>
<td class="text-right"><p>100</p></td>
<td class="text-right"><p>40</p></td>
</tr>
<tr class="row-even"><td><p>GwPercValue</p></td>
<td class="text-right"><p>0.01</p></td>
<td class="text-right"><p>2</p></td>
<td class="text-right"><p>0.8</p></td>
<td class="text-right"><p>0.878763</p></td>
</tr>
<tr class="row-odd"><td><p>LZThreshold</p></td>
<td class="text-right"><p>0</p></td>
<td class="text-right"><p>30</p></td>
<td class="text-right"><p>10</p></td>
<td class="text-right"><p>5.65075</p></td>
</tr>
<tr class="row-even"><td><p>b_Xinanjiang</p></td>
<td class="text-right"><p>0.01</p></td>
<td class="text-right"><p>5</p></td>
<td class="text-right"><p>0.5</p></td>
<td class="text-right"><p>3.09004</p></td>
</tr>
<tr class="row-odd"><td><p>PowerPrefFlow</p></td>
<td class="text-right"><p>0.5</p></td>
<td class="text-right"><p>8</p></td>
<td class="text-right"><p>4</p></td>
<td class="text-right"><p>1.51084</p></td>
</tr>
<tr class="row-even"><td><p>SnowMeltCoef</p></td>
<td class="text-right"><p>2.5</p></td>
<td class="text-right"><p>6.5</p></td>
<td class="text-right"><p>4</p></td>
<td class="text-right"><p>5.10491</p></td>
</tr>
<tr class="row-odd"><td><p>CalChanMan1</p></td>
<td class="text-right"><p>0.5</p></td>
<td class="text-right"><p>2</p></td>
<td class="text-right"><p>1</p></td>
<td class="text-right"><p>4.49689</p></td>
</tr>
<tr class="row-even"><td><p>CalChanMan3</p></td>
<td class="text-right"><p>0.5</p></td>
<td class="text-right"><p>5</p></td>
<td class="text-right"><p>3</p></td>
<td class="text-right"><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>GwLoss</p></td>
<td class="text-right"><p>0</p></td>
<td class="text-right"><p>0.5</p></td>
<td class="text-right"><p>0</p></td>
<td class="text-right"><p>0.0866118</p></td>
</tr>
<tr class="row-even"><td><p>TransSub</p></td>
<td class="text-right"><p>0</p></td>
<td class="text-right"><p>0.12</p></td>
<td class="text-right"><p>0</p></td>
<td class="text-right"><p>0.000135783</p></td>
</tr>
</tbody>
</table>
<p>As always, let us quickly load the necessary libraries before we start.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
<p>Remember, all the parameters and settings are done in xml format, to adapt the settings files we will therefore create 3 helper functions:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">set_textvar</span></code>: to change whatever parameter in a specific xml file</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">generate_random_params</span></code>: to generate <em>N</em> random samples for a parameter</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">run_lisflood</span></code>: obviously to run LISFLOOD</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Universally applicable Lisflood TSS Read Function</span>
<span class="k">def</span> <span class="nf">read_lisflood_tss</span><span class="p">(</span>
    <span class="n">out_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">varname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">run_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">start_date</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">n_gauges</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">skiprows</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">freq</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;D&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Robust reader for LISFLOOD .tss files with varname+runname convention.</span>
<span class="sd">    Handles small float values correctly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># run_name = out_dir.name</span>
    <span class="n">tss_file</span> <span class="o">=</span> <span class="n">out_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">varname</span><span class="si">}{</span><span class="n">run_name</span><span class="si">}</span><span class="s2">.tss&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">tss_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Missing LISFLOOD file → filled with NaNs: </span><span class="si">{</span><span class="n">tss_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;gauge_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_gauges</span><span class="p">)]</span>
        <span class="p">)</span>

    <span class="c1"># Read the file using whitespace delimiter for robustness</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
        <span class="n">tss_file</span><span class="p">,</span>
        <span class="n">skiprows</span><span class="o">=</span><span class="n">skiprows</span><span class="p">,</span>
        <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">usecols</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">n_gauges</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>  <span class="c1"># only keep index + gauges</span>
        <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="nb">float</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_gauges</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)}</span>  <span class="c1"># gauge columns as float</span>
    <span class="p">)</span>

    <span class="c1"># Only keep the first n_gauges + 1 columns (date/index + gauges)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">n_gauges</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Convert gauge columns to float safely</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_gauges</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">df</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># Set column names</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;gauge_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_gauges</span><span class="p">)]</span>

    <span class="c1"># Create date index</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">set_textvar</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">new_value</span><span class="p">,</span> <span class="n">must_exist</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modify the &#39;value&#39; attribute of a &lt;textvar&gt; element in a LISFLOOD settings file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    root : xml.etree.ElementTree.Element</span>
<span class="sd">        Root element of the parsed XML tree (typically &lt;lfsettings&gt;).</span>
<span class="sd">    name : str</span>
<span class="sd">        Value of the &#39;name&#39; attribute of the &lt;textvar&gt; to modify.</span>
<span class="sd">    new_value : str or float or int</span>
<span class="sd">        New value to assign to the &#39;value&#39; attribute.</span>
<span class="sd">    must_exist : bool, optional</span>
<span class="sd">        If True (default), raise an error if the parameter is not found.</span>
<span class="sd">        If False, silently do nothing if the parameter does not exist.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if the parameter was found and modified, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">tv</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s2">&quot;textvar&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tv</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">tv</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_value</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">must_exist</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;textvar &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found in settings file&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">generate_random_params</span><span class="p">(</span><span class="n">param_bounds</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate random parameter sets within defined bounds.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    param_bounds : dict</span>
<span class="sd">        Dictionary with parameter names as keys and (min, max) tuples as values.</span>
<span class="sd">    n_samples : int</span>
<span class="sd">        Number of parameter sets to generate.</span>
<span class="sd">    seed : int, optional</span>
<span class="sd">        Random seed for reproducibility.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of dict</span>
<span class="sd">        List of parameter dictionaries.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="n">param_sets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">)</span> <span class="ow">in</span> <span class="n">param_bounds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">)</span>
        <span class="n">param_sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">param_sets</span>


<span class="k">def</span> <span class="nf">run_lisflood</span><span class="p">(</span><span class="n">settings_file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run LISFLOOD model using command line.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    settings_file : str</span>
<span class="sd">        Path to the settings XML file.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Return code (0 = success).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;lisflood&quot;</span><span class="p">,</span>
        <span class="n">settings_file</span><span class="p">,</span>
        <span class="c1"># &quot;--stepstart&quot;, step_start,</span>
        <span class="c1"># &quot;--stepend&quot;, step_end,</span>
        <span class="c1"># &quot;--outputdir&quot;, str(output_dir)</span>
    <span class="p">]</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span>

<span class="k">def</span> <span class="nf">fun_kge</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
    <span class="c1"># Align on overlapping dates</span>
    <span class="n">obs_aligned</span><span class="p">,</span> <span class="n">sim_aligned</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># Drop any NaNs</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">obs_aligned</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">sim_aligned</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
    <span class="n">obs_aligned</span> <span class="o">=</span> <span class="n">obs_aligned</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">sim_aligned</span> <span class="o">=</span> <span class="n">sim_aligned</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">obs_aligned</span><span class="p">,</span> <span class="n">sim_aligned</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">sim_aligned</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">obs_aligned</span><span class="p">)</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sim_aligned</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">obs_aligned</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">r</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">alpha</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">beta</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="a-general-configuration">
<h2>4a) General Configuration<a class="headerlink" href="#a-general-configuration" title="Permalink to this heading">#</a></h2>
<p>We actually prepared already 2 calibration settings files in the <code class="docutils literal notranslate"><span class="pre">\settings</span></code> folder:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Settings_PreRun_Calib</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Settings_Run_Calib</span></code></p></li>
</ol>
<p>The two settings files should in theory be already prepared to include a short calibration period (for demonstration purposes to improve run times) and additionally they should only print discharge in order to quickly demonstrate how discharge performs with respect to the calibrated GloFAS long-term run. </br>
The simulation period is set just 5 years including a 3 years warm-up (1975 - 1979).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ============================================================</span>
<span class="c1"># CONFIGURATION - Change these values as needed</span>
<span class="c1"># ============================================================</span>

<span class="c1"># Number of Monte Carlo samples</span>
<span class="n">N_SAMPLES</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># Can be changed to any number (e.g., 100, 1000)</span>

<span class="c1"># Paths</span>
<span class="n">BASE_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span>
<span class="n">IN_DIR</span> <span class="o">=</span> <span class="n">BASE_DIR</span> <span class="o">/</span> <span class="s2">&quot;settings&quot;</span>
<span class="n">OUT_DIR</span> <span class="o">=</span> <span class="n">BASE_DIR</span> <span class="o">/</span> <span class="s2">&quot;out&quot;</span> <span class="o">/</span> <span class="s2">&quot;calib_mc&quot;</span>
<span class="n">SETTINGS_FILE_PRE</span> <span class="o">=</span> <span class="s2">&quot;Settings_PreRun_Calib.xml&quot;</span>
<span class="n">SETTINGS_FILE</span> <span class="o">=</span> <span class="s2">&quot;Settings_Run_Calib.xml&quot;</span>

<span class="c1"># Create output directory</span>
<span class="n">OUT_DIR</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Simulation period (for this example we recomend to keep it short)</span>
<span class="n">STEP_START</span> <span class="o">=</span> <span class="s2">&quot;01/02/1996 00:00&quot;</span>
<span class="n">STEP_END</span> <span class="o">=</span> <span class="s2">&quot;01/01/2000 00:00&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>If you want to change the provided LISFLOOD settings files in order to change the simulation period for example, we here provide a small example how easily it can be done with our helper functions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define setup</span>
<span class="n">setup_lf</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;StepStart&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">STEP_START</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;StepEnd&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">STEP_END</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PathOut&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">OUT_DIR</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PathInit&quot;</span><span class="p">:</span> <span class="s2">&quot;$(PathRoot)/initial/calib_mc&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Copy and modify settings file (do this ONCE before the loop)</span>
<span class="n">settings_path</span> <span class="o">=</span> <span class="n">IN_DIR</span> <span class="o">/</span> <span class="n">SETTINGS_FILE</span>
<span class="n">settings_pre_path</span> <span class="o">=</span> <span class="n">IN_DIR</span> <span class="o">/</span> <span class="n">SETTINGS_FILE_PRE</span>
<span class="n">settings_tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">settings_path</span><span class="p">)</span>
<span class="n">settings_pre_tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">settings_pre_path</span><span class="p">)</span>
<span class="n">root</span> <span class="o">=</span> <span class="n">settings_tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
<span class="n">root_pre</span> <span class="o">=</span> <span class="n">settings_pre_tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>

<span class="c1"># Loop through parameters and apply changes</span>
<span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">setup_lf</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">changed</span> <span class="o">=</span> <span class="n">set_textvar</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">must_exist</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">set_textvar</span><span class="p">(</span><span class="n">root_pre</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">must_exist</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">changed</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠ Parameter &#39;</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">&#39; not found — no change applied&quot;</span><span class="p">)</span>

<span class="c1"># Write the modified files ONCE after all changes</span>
<span class="n">settings_tree</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">IN_DIR</span> <span class="o">/</span> <span class="n">SETTINGS_FILE</span><span class="p">)</span>
<span class="n">settings_pre_tree</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">IN_DIR</span> <span class="o">/</span> <span class="n">SETTINGS_FILE_PRE</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="b-actual-calibration">
<h2>4b) Actual Calibration<a class="headerlink" href="#b-actual-calibration" title="Permalink to this heading">#</a></h2>
<p>In the following we will first define our calibration parameters and according ranges, before we apply the random sampling followed by the calibration run for the already defined <em>N</em> (sample size).</p>
<section id="define-parameter-bounds">
<h3>Define Parameter Bounds<a class="headerlink" href="#define-parameter-bounds" title="Permalink to this heading">#</a></h3>
<p>First we define the parameters and their bounds</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Parameter bounds for Monte Carlo sampling</span>
<span class="c1"># (name, min_value, max_value)</span>
<span class="n">PARAM_BOUNDS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;UpperZoneTimeConstant&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span>
    <span class="s2">&quot;LowerZoneTimeConstant&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">730</span><span class="p">),</span>
    <span class="s2">&quot;GwPercValue&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="s2">&quot;LZThreshold&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
    <span class="s2">&quot;b_Xinanjiang&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s2">&quot;PowerPrefFlow&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
    <span class="s2">&quot;SnowMeltCoef&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">),</span>
    <span class="s2">&quot;CalChanMan1&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="s2">&quot;CalChanMan3&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="s2">&quot;GwLoss&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
    <span class="s2">&quot;TransSub&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">)</span>
<span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of parameters: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">PARAM_BOUNDS</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Monte Carlo samples: </span><span class="si">{</span><span class="n">N_SAMPLES</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Parameter bounds:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">)</span> <span class="ow">in</span> <span class="n">PARAM_BOUNDS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: [</span><span class="si">{</span><span class="n">min_val</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">max_val</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of parameters: 11
Monte Carlo samples: 10

Parameter bounds:
  UpperZoneTimeConstant: [0.01, 40]
  LowerZoneTimeConstant: [40, 730]
  GwPercValue: [0.01, 2]
  LZThreshold: [0, 30]
  b_Xinanjiang: [0.01, 5]
  PowerPrefFlow: [0.5, 8]
  SnowMeltCoef: [2.5, 6.5]
  CalChanMan1: [0.5, 2]
  CalChanMan3: [0.5, 5]
  GwLoss: [0, 0.5]
  TransSub: [0, 0.12]
</pre></div>
</div>
</div>
</div>
</section>
<section id="monte-carlo-sampling">
<h3>Monte Carlo Sampling<a class="headerlink" href="#monte-carlo-sampling" title="Permalink to this heading">#</a></h3>
<p>Now, we use the helper function to generate random parameter sets that are used for the calibration.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate random parameter sets</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>  <span class="c1"># For reproducibility</span>
<span class="n">param_sets</span> <span class="o">=</span> <span class="n">generate_random_params</span><span class="p">(</span><span class="n">PARAM_BOUNDS</span><span class="p">,</span> <span class="n">N_SAMPLES</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">param_sets</span><span class="p">)</span><span class="si">}</span><span class="s2"> random parameter sets&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">First 3 parameter sets:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param_sets</span><span class="p">[:</span><span class="mi">3</span><span class="p">]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Set </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Generated 10 random parameter sets

First 3 parameter sets:

Set 1:
  UpperZoneTimeConstant: 14.9879
  LowerZoneTimeConstant: 695.9929
  GwPercValue: 1.4667
  LZThreshold: 17.9598
  b_Xinanjiang: 0.7885
  PowerPrefFlow: 1.6700
  SnowMeltCoef: 2.7323
  CalChanMan1: 1.7993
  CalChanMan3: 3.2050
  GwLoss: 0.3540
  TransSub: 0.0025

Set 2:
  UpperZoneTimeConstant: 38.7967
  LowerZoneTimeConstant: 614.3854
  GwPercValue: 0.4326
  LZThreshold: 5.4547
  b_Xinanjiang: 0.9252
  PowerPrefFlow: 2.7818
  SnowMeltCoef: 4.5990
  CalChanMan1: 1.1479
  CalChanMan3: 1.8105
  GwLoss: 0.3059
  TransSub: 0.0167

Set 3:
  UpperZoneTimeConstant: 11.6929
  LowerZoneTimeConstant: 292.7897
  GwPercValue: 0.9176
  LZThreshold: 23.5553
  b_Xinanjiang: 1.0064
  PowerPrefFlow: 4.3568
  SnowMeltCoef: 4.8697
  CalChanMan1: 0.5697
  CalChanMan3: 3.2340
  GwLoss: 0.0853
  TransSub: 0.0078
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run Monte Carlo simulations</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting Monte Carlo Calibration (</span><span class="si">{</span><span class="n">N_SAMPLES</span><span class="si">}</span><span class="s2"> runs)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="c1"># Loop over parameter sets</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param_sets</span><span class="p">):</span>
    <span class="n">run_id</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Run </span><span class="si">{</span><span class="n">run_id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">N_SAMPLES</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
    
    <span class="c1"># Create unique output directory for this run</span>
    <span class="n">run_out_dir</span> <span class="o">=</span> <span class="n">OUT_DIR</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;run_</span><span class="si">{</span><span class="n">run_id</span><span class="si">:</span><span class="s2">04d</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">run_out_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># Copy and modify settings file</span>
    <span class="n">settings_path</span> <span class="o">=</span> <span class="n">IN_DIR</span> <span class="o">/</span> <span class="n">SETTINGS_FILE</span>
    <span class="n">settings_pre_path</span> <span class="o">=</span> <span class="n">IN_DIR</span> <span class="o">/</span> <span class="n">SETTINGS_FILE_PRE</span>
    <span class="n">settings_tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">settings_path</span><span class="p">)</span>
    <span class="n">settings_pre_tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">settings_pre_path</span><span class="p">)</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">settings_tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
    <span class="n">root_pre</span> <span class="o">=</span> <span class="n">settings_pre_tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>

    <span class="c1"># Set output path</span>
    <span class="n">set_textvar</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;PathOut&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">run_out_dir</span><span class="p">),</span> <span class="n">must_exist</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">set_textvar</span><span class="p">(</span><span class="n">root_pre</span><span class="p">,</span> <span class="s2">&quot;PathOut&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">run_out_dir</span><span class="p">),</span> <span class="n">must_exist</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
   
    <span class="c1"># Make sure Init Folder is correct -&gt; in this case init files (lzavin) are in the output fodler to make it simple</span>
    <span class="c1"># set_textvar(root, &quot;PathInit&quot;, &quot;$(PathRoot)/initial/calib_mc&quot;, must_exist=False)</span>
    <span class="c1"># set_textvar(root_pre, &quot;PathInit&quot;, &quot;$(PathRoot)/initial/calib_mc&quot;, must_exist=False)</span>
    <span class="n">set_textvar</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;PathInit&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">run_out_dir</span><span class="p">),</span> <span class="n">must_exist</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">set_textvar</span><span class="p">(</span><span class="n">root_pre</span><span class="p">,</span> <span class="s2">&quot;PathInit&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">run_out_dir</span><span class="p">),</span> <span class="n">must_exist</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Set calibration parameters</span>
    <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">set_textvar</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">must_exist</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">set_textvar</span><span class="p">(</span><span class="n">root_pre</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">must_exist</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="c1"># Write modified settings file to calib folder and run from there</span>
    <span class="n">run_settings_file</span> <span class="o">=</span> <span class="n">run_out_dir</span> <span class="o">/</span> <span class="s2">&quot;settings_mc.xml&quot;</span>
    <span class="n">pre_run_settings_file</span> <span class="o">=</span> <span class="n">run_out_dir</span> <span class="o">/</span> <span class="s2">&quot;settings_pre_mc.xml&quot;</span>
    <span class="n">settings_tree</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">run_settings_file</span><span class="p">)</span>
    <span class="n">settings_pre_tree</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pre_run_settings_file</span><span class="p">)</span>

    <span class="c1"># Run LISFLOOD (both Prerun &amp; Actual Run)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Parameters: &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">())[:</span><span class="mi">3</span><span class="p">]])</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span><span class="p">)</span>
    
    <span class="c1"># Pre-Run</span>
    <span class="n">run_lisflood</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pre_run_settings_file</span><span class="p">))</span>
    <span class="c1"># Actual Run</span>
    <span class="n">return_code</span> <span class="o">=</span> <span class="n">run_lisflood</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">run_settings_file</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">return_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✓ Run completed successfully&quot;</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;run_id&quot;</span><span class="p">:</span> <span class="n">run_id</span><span class="p">,</span>
            <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span>
            <span class="s2">&quot;return_code&quot;</span><span class="p">:</span> <span class="n">return_code</span><span class="p">,</span>
            <span class="s2">&quot;output_dir&quot;</span><span class="p">:</span> <span class="n">run_out_dir</span>
        <span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ✗ Run failed with code </span><span class="si">{</span><span class="n">return_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;run_id&quot;</span><span class="p">:</span> <span class="n">run_id</span><span class="p">,</span>
            <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span>
            <span class="s2">&quot;return_code&quot;</span><span class="p">:</span> <span class="n">return_code</span><span class="p">,</span>
            <span class="s2">&quot;output_dir&quot;</span><span class="p">:</span> <span class="n">run_out_dir</span>
        <span class="p">})</span>

<span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Monte Carlo Calibration Complete&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total time: </span><span class="si">{</span><span class="n">elapsed_time</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> seconds (</span><span class="si">{</span><span class="n">elapsed_time</span><span class="o">/</span><span class="mi">60</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> minutes)&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successful runs: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;return_code&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">N_SAMPLES</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>============================================================
Starting Monte Carlo Calibration (10 runs)
============================================================

--- Run 1/10 ---
  Parameters: UpperZoneTimeConstant=14.99, LowerZoneTimeConstant=695.99, GwPercValue=1.47...
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">line</span> <span class="mi">52</span>
<span class="nn">     49 print(&quot;, &quot;.join([f&quot;{k}={v:.2f}&quot; for k, v</span> in <span class="ni">list(params.items</span><span class="nt">())[:3]]) + &quot;...&quot;)</span>
<span class="g g-Whitespace">     </span><span class="mi">51</span> <span class="c1"># Pre-Run</span>
<span class="ne">---&gt; </span><span class="mi">52</span> <span class="n">run_lisflood</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pre_run_settings_file</span><span class="p">))</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span> <span class="c1"># Actual Run</span>
<span class="g g-Whitespace">     </span><span class="mi">54</span> <span class="n">return_code</span> <span class="o">=</span> <span class="n">run_lisflood</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">run_settings_file</span><span class="p">))</span>

<span class="nn">Cell In[2], line 133,</span> in <span class="ni">run_lisflood</span><span class="nt">(settings_file)</span>
<span class="g g-Whitespace">    </span><span class="mi">112</span><span class="w"> </span><span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">113</span><span class="sd"> Run LISFLOOD model using command line.</span>
<span class="g g-Whitespace">    </span><span class="mi">114</span><span class="sd"> </span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">    </span><span class="mi">123</span><span class="sd">     Return code (0 = success).</span>
<span class="g g-Whitespace">    </span><span class="mi">124</span><span class="sd"> &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">125</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span>
<span class="g g-Whitespace">    </span><span class="mi">126</span>     <span class="s2">&quot;lisflood&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">127</span>     <span class="n">settings_file</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">130</span>     <span class="c1"># &quot;--outputdir&quot;, str(output_dir)</span>
<span class="g g-Whitespace">    </span><span class="mi">131</span> <span class="p">]</span>
<span class="ne">--&gt; </span><span class="mi">133</span> <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">134</span> <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span>

<span class="nn">File ~/.conda/envs/lisflood-dev/lib/python3.8/subprocess.py:495,</span> in <span class="ni">run</span><span class="nt">(input, capture_output, timeout, check, *popenargs, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">493</span> <span class="k">with</span> <span class="n">Popen</span><span class="p">(</span><span class="o">*</span><span class="n">popenargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">process</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">494</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">495</span>         <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">496</span>     <span class="k">except</span> <span class="n">TimeoutExpired</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">497</span>         <span class="n">process</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>

<span class="nn">File ~/.conda/envs/lisflood-dev/lib/python3.8/subprocess.py:1028,</span> in <span class="ni">Popen.communicate</span><span class="nt">(self, input, timeout)</span>
<span class="g g-Whitespace">   </span><span class="mi">1025</span>     <span class="n">endtime</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">   </span><span class="mi">1027</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1028</span>     <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_communicate</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">endtime</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1029</span> <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1030</span>     <span class="c1"># https://bugs.python.org/issue25942</span>
<span class="g g-Whitespace">   </span><span class="mi">1031</span>     <span class="c1"># See the detailed comment in .wait().</span>
<span class="g g-Whitespace">   </span><span class="mi">1032</span>     <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

<span class="nn">File ~/.conda/envs/lisflood-dev/lib/python3.8/subprocess.py:1884,</span> in <span class="ni">Popen._communicate</span><span class="nt">(self, input, endtime, orig_timeout)</span>
<span class="g g-Whitespace">   </span><span class="mi">1877</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_check_timeout</span><span class="p">(</span><span class="n">endtime</span><span class="p">,</span> <span class="n">orig_timeout</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1878</span>                         <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1879</span>                         <span class="n">skip_check_and_raise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1880</span>     <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>  <span class="c1"># Impossible :)</span>
<span class="g g-Whitespace">   </span><span class="mi">1881</span>         <span class="s1">&#39;_check_timeout(..., skip_check_and_raise=True) &#39;</span>
<span class="g g-Whitespace">   </span><span class="mi">1882</span>         <span class="s1">&#39;failed to raise TimeoutExpired.&#39;</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">1884</span> <span class="n">ready</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1885</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_timeout</span><span class="p">(</span><span class="n">endtime</span><span class="p">,</span> <span class="n">orig_timeout</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1887</span> <span class="c1"># XXX Rewrite these to use non-blocking I/O on the file</span>
<span class="g g-Whitespace">   </span><span class="mi">1888</span> <span class="c1"># objects; they are no longer using C stdio!</span>

<span class="nn">File ~/.conda/envs/lisflood-dev/lib/python3.8/selectors.py:415,</span> in <span class="ni">_PollLikeSelector.select</span><span class="nt">(self, timeout)</span>
<span class="g g-Whitespace">    </span><span class="mi">413</span> <span class="n">ready</span> <span class="o">=</span> <span class="p">[]</span>
<span class="g g-Whitespace">    </span><span class="mi">414</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">415</span>     <span class="n">fd_event_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selector</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">416</span> <span class="k">except</span> <span class="ne">InterruptedError</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">417</span>     <span class="k">return</span> <span class="n">ready</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="c-compare-calibration-results">
<h2>4c) Compare Calibration Results<a class="headerlink" href="#c-compare-calibration-results" title="Permalink to this heading">#</a></h2>
<p>We will now load the discharge time series and compare them against each other and the observations to see how the runs differ.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read Observed Q Data</span>
<span class="n">OBS_FILE</span> <span class="o">=</span> <span class="n">BASE_DIR</span> <span class="o">/</span> <span class="s2">&quot;station&quot;</span><span class="o">/</span> <span class="s2">&quot;observations.csv&quot;</span> 
<span class="n">qobs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">OBS_FILE</span><span class="p">,</span><span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;qobs&quot;</span><span class="p">],</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">],</span><span class="n">dayfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">qobs</span> <span class="o">=</span> <span class="n">qobs</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span>
<span class="c1"># get rid of the timestamp</span>
<span class="n">qobs</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">qobs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>

<span class="c1"># Read Simulated Q Data</span>
<span class="n">run_name</span> <span class="o">=</span> <span class="s2">&quot;long_term_run&quot;</span>
<span class="n">DIS_FILES</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">OUT_DIR</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;*/dis</span><span class="si">{</span><span class="n">run_name</span><span class="si">}</span><span class="s2">.tss&quot;</span><span class="p">))</span>
<span class="n">DIS_FOLDS</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">OUT_DIR</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;run_*&quot;</span><span class="p">))</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">DIS_FILES</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

<span class="c1"># Extract number of gauges</span>
<span class="n">n_gauges</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">skiprows</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">n_gauges</span>

<span class="c1"># Read Sim (all Vars)</span>
<span class="n">var</span> <span class="o">=</span> <span class="s2">&quot;dis&quot;</span>

<span class="n">qsim_cal</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Actual Read of files</span>
<span class="k">for</span> <span class="n">fold</span> <span class="ow">in</span> <span class="n">DIS_FOLDS</span><span class="p">:</span>
        <span class="n">qsim</span> <span class="o">=</span> <span class="n">read_lisflood_tss</span><span class="p">(</span>
            <span class="n">fold</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">run_name</span><span class="p">,</span> <span class="n">STEP_START</span><span class="p">,</span> <span class="n">n_gauges</span><span class="p">,</span> <span class="n">skiprows</span>
        <span class="p">)</span>
        <span class="n">qsim_cal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qsim</span><span class="p">)</span>

<span class="c1"># Convert to DataFrame</span>
<span class="n">run_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">DIS_FILES</span><span class="p">]</span>  <span class="c1"># e.g., &quot;run_0001&quot;, &quot;run_0002&quot;, ...</span>
<span class="n">qsim_cal</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">qsim_cal</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">qsim_cal</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">run_names</span>

<span class="c1"># Load also long-term run simulation from before</span>
<span class="n">outfold</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/home/schafti/Documents/01_Hydrology/01_Lisflood/00_SourceCode/01_Playground/01_Test_Usecase/create_submodel_7859/7859_testing/out/long_term_run/&quot;</span><span class="p">)</span>
<span class="n">STEP_START_ORIG</span> <span class="o">=</span> <span class="s2">&quot;01/02/1975 00:00&quot;</span> 
<span class="n">qsim_original</span> <span class="o">=</span> <span class="n">read_lisflood_tss</span><span class="p">(</span>
            <span class="n">outfold</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">run_name</span><span class="p">,</span> <span class="n">STEP_START_ORIG</span><span class="p">,</span> <span class="n">n_gauges</span><span class="p">,</span> <span class="n">skiprows</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We should also  quickly align the dataframes!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Align everything</span>
<span class="c1"># common_index = qobs.index.intersection(qsim_cal.index)</span>
<span class="c1"># qobs_al = qobs.loc[common_index]</span>
<span class="c1"># qsim_al = qsim_cal.loc[common_index]</span>

<span class="n">qsim_cal</span><span class="p">,</span> <span class="n">qobs</span> <span class="o">=</span> <span class="n">qsim_cal</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">qobs</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">qsim_original</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">qsim_original</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">qobs</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="discharge-results">
<h3>Discharge Results<a class="headerlink" href="#discharge-results" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- Plot all simulations in grey ---</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Plot each simulation in grey</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">qsim_cal</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">qsim_cal</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

<span class="c1"># Plot observed data in black</span>
<span class="n">qobs</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Observed&quot;</span><span class="p">)</span>

<span class="c1"># Plot calibrated GloFAS long term run from before</span>
<span class="n">qsim_original</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;GloFAS Cal.&quot;</span><span class="p">)</span>
 
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Q (m³/s)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Monte Carlo Simulations (n=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">qsim_cal</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">) vs Observed&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">mc_handle</span>   <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>                      <span class="c1"># first MC line</span>
<span class="n">obs_handle</span>  <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># observed</span>
<span class="n">orig_handle</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>                     <span class="c1"># last line</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
    <span class="p">[</span><span class="n">mc_handle</span><span class="p">,</span> <span class="n">obs_handle</span><span class="p">,</span> <span class="n">orig_handle</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;MC Cal.&quot;</span><span class="p">,</span> <span class="s2">&quot;Obs&quot;</span><span class="p">,</span> <span class="s2">&quot;GloFAS Cal.&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>


<span class="c1"># Calculate KGE for each run</span>
<span class="n">kge_results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">qsim_cal</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">kge_val</span><span class="o">=</span> <span class="n">fun_kge</span><span class="p">(</span><span class="n">qobs</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">qsim_cal</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
    <span class="n">kge_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s2">&quot;run&quot;</span><span class="p">:</span> <span class="n">col</span><span class="p">,</span>
        <span class="s2">&quot;KGE&quot;</span><span class="p">:</span> <span class="n">kge_val</span><span class="p">,</span>
    <span class="p">})</span>
<span class="n">kge_val_glofas</span> <span class="o">=</span> <span class="n">fun_kge</span><span class="p">(</span><span class="n">qobs</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">qsim_original</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
<span class="n">kge_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
    <span class="s2">&quot;run&quot;</span><span class="p">:</span> <span class="s2">&quot;GloFAS_Cal&quot;</span><span class="p">,</span>
    <span class="s2">&quot;KGE&quot;</span><span class="p">:</span> <span class="n">kge_val_glofas</span><span class="p">,</span>
<span class="p">})</span>
<span class="c1"># Create DataFrame</span>
<span class="n">kge_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">kge_results</span><span class="p">)</span>
<span class="n">kge_df</span> <span class="o">=</span> <span class="n">kge_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;KGE&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;KGE Results (sorted by KGE):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">kge_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Best run: </span><span class="si">{</span><span class="n">kge_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;run&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> with KGE = </span><span class="si">{</span><span class="n">kge_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;KGE&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean KGE: </span><span class="si">{</span><span class="n">kge_df</span><span class="p">[</span><span class="s1">&#39;KGE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>KGE Results (sorted by KGE):
       run       KGE
GloFAS_Cal  0.713969
  run_0003  0.034059
  run_0009  0.023951
  run_0002  0.023254
  run_0010  0.017274
  run_0001  0.004435
  run_0008 -0.061810
  run_0006 -0.069593
  run_0005 -0.084286
  run_0007 -0.098712
  run_0004 -0.123779

Best run: GloFAS_Cal with KGE = 0.714
Mean KGE: 0.034
</pre></div>
</div>
<img alt="_images/afd93e2037d7f4d2b69cd6e9b16290d8352cd793e5076d3f7be19366105f9f29.png" src="_images/afd93e2037d7f4d2b69cd6e9b16290d8352cd793e5076d3f7be19366105f9f29.png" />
</div>
</div>
</section>
<section id="parameterizations-check">
<h3>Parameterizations Check<a class="headerlink" href="#parameterizations-check" title="Permalink to this heading">#</a></h3>
<p>We see that we did not beat the original GloFAS calibration run with our MC sampling approach, albeit some of the runs are pretty close.</br>
However, let us inspect the worst run, to get an idea what happens there.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract the worst run, its index is of course the run number -1 </span>
<span class="n">sim</span> <span class="o">=</span> <span class="s2">&quot;run_0004&quot;</span>
<span class="n">sim_ind</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">test_params</span> <span class="o">=</span> <span class="n">param_sets</span><span class="p">[</span><span class="n">sim_ind</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">qobs</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Observed&quot;</span><span class="p">)</span>
<span class="n">qsim_cal</span><span class="p">[</span><span class="n">sim</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span> <span class="s2">&quot;blue&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Q (m³/s)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/411c1f4904106c07fa15452e8f96a7b5bbe65176cc5253cf90fbae568bddd680.png" src="_images/411c1f4904106c07fa15452e8f96a7b5bbe65176cc5253cf90fbae568bddd680.png" />
</div>
</div>
<p>In the beginning of this notebook we provided the original calibrated GloFAS parameter set for the Aisen River, so let us have a look at the parameter differences that could be responsible for the very smoothed behavior of the bad LISFLOOD simulation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calibration parameters (GloFAS Calib. Aisen)</span>
<span class="n">calib_params</span> <span class="o">=</span> <span class="p">{</span>
 <span class="s1">&#39;UpperZoneTimeConstant&#39;</span><span class="p">:</span> <span class="mf">9.0402</span><span class="p">,</span>
 <span class="s1">&#39;LowerZoneTimeConstant&#39;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
 <span class="s1">&#39;GwPercValue&#39;</span><span class="p">:</span> <span class="mf">0.878763</span><span class="p">,</span>
 <span class="s1">&#39;LZThreshold&#39;</span><span class="p">:</span> <span class="mf">5.65075</span><span class="p">,</span>
 <span class="s1">&#39;b_Xinanjiang&#39;</span><span class="p">:</span> <span class="mf">3.09004</span><span class="p">,</span>
 <span class="s1">&#39;PowerPrefFlow&#39;</span><span class="p">:</span> <span class="mf">1.51084</span><span class="p">,</span>
 <span class="s1">&#39;SnowMeltCoef&#39;</span><span class="p">:</span> <span class="mf">5.10491</span><span class="p">,</span>
 <span class="s1">&#39;CalChanMan1&#39;</span><span class="p">:</span> <span class="mf">4.49689</span><span class="p">,</span>
 <span class="s1">&#39;CalChanMan3&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="s1">&#39;GwLoss&#39;</span><span class="p">:</span> <span class="mf">0.0866118</span><span class="p">,</span>
 <span class="s1">&#39;TransSub&#39;</span><span class="p">:</span> <span class="mf">0.000135783</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>Let us check the difference among the parameter sets!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Iterate and print</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">test_params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

    <span class="n">test_val</span> <span class="o">=</span> <span class="n">test_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="n">glofas_val</span> <span class="o">=</span> <span class="n">calib_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="n">abs_diff</span> <span class="o">=</span> <span class="n">test_val</span> <span class="o">-</span> <span class="n">glofas_val</span>
    <span class="n">rel_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">abs_diff</span> <span class="o">/</span> <span class="n">glofas_val</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">glofas_val</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">:</span><span class="s2">25s</span><span class="si">}</span><span class="s2"> | &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;Test Set: </span><span class="si">{</span><span class="n">test_val</span><span class="si">:</span><span class="s2">10.5f</span><span class="si">}</span><span class="s2"> | &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;GloFAS Cal: </span><span class="si">{</span><span class="n">glofas_val</span><span class="si">:</span><span class="s2">10.5f</span><span class="si">}</span><span class="s2"> | &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;Diff: </span><span class="si">{</span><span class="n">abs_diff</span><span class="si">:</span><span class="s2">10.5f</span><span class="si">}</span><span class="s2"> | &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;%Diff: </span><span class="si">{</span><span class="n">rel_diff</span><span class="si">:</span><span class="s2">8.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>UpperZoneTimeConstant     | Test Set:   37.95593 | GloFAS Cal:    9.04020 | Diff:   28.91573 | %Diff:   319.86%
LowerZoneTimeConstant     | Test Set:  706.28610 | GloFAS Cal:   40.00000 | Diff:  666.28610 | %Diff:  1665.72%
GwPercValue               | Test Set:    1.61871 | GloFAS Cal:    0.87876 | Diff:    0.73995 | %Diff:    84.20%
LZThreshold               | Test Set:    9.13841 | GloFAS Cal:    5.65075 | Diff:    3.48766 | %Diff:    61.72%
b_Xinanjiang              | Test Set:    0.49738 | GloFAS Cal:    3.09004 | Diff:   -2.59266 | %Diff:   -83.90%
PowerPrefFlow             | Test Set:    5.63175 | GloFAS Cal:    1.51084 | Diff:    4.12091 | %Diff:   272.76%
SnowMeltCoef              | Test Set:    4.26061 | GloFAS Cal:    5.10491 | Diff:   -0.84430 | %Diff:   -16.54%
CalChanMan1               | Test Set:    0.68306 | GloFAS Cal:    4.49689 | Diff:   -3.81383 | %Diff:   -84.81%
CalChanMan3               | Test Set:    2.72830 | GloFAS Cal:    1.00000 | Diff:    1.72830 | %Diff:   172.83%
GwLoss                    | Test Set:    0.01719 | GloFAS Cal:    0.08661 | Diff:   -0.06942 | %Diff:   -80.15%
TransSub                  | Test Set:    0.10912 | GloFAS Cal:    0.00014 | Diff:    0.10898 | %Diff: 80262.38%
</pre></div>
</div>
</div>
</div>
<p>We can immediately spot a couple of significant differences, such as the UZTC, LZTC and PowerPrefFlow parameters that shows notable shifts from the best run.</br>
In fact, the best run LZTC is at the lower edge of the allowed range while the UZTC, LZTC of the bad run is close to the upper limit of both parameters!</br></p>
<p>However, you could for example check how the parameters of the best MC run look compared to the best run and the worst run to get a better idea.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="3_Run.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><strong>3) Model Run</strong></p>
      </div>
    </a>
    <a class="right-next"
       href="Excursus_Initialization.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><strong>Excursus) Model Initialization Run</strong></p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#parameters-and-their-bounds">Parameters and their bounds</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-general-configuration">4a) General Configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#b-actual-calibration">4b) Actual Calibration</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-parameter-bounds">Define Parameter Bounds</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#monte-carlo-sampling">Monte Carlo Sampling</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#c-compare-calibration-results">4c) Compare Calibration Results</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#discharge-results">Discharge Results</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#parameterizations-check">Parameterizations Check</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Joint Research Center - European Commission
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2026.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>