

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>3) Model Run &#8212; LISFLOOD - Río Aisén Use Case</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '3_Run';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="4) Monte Carlo Calibration Example" href="4_Calibration_MC.html" />
    <link rel="prev" title="2) Model Initialization Run" href="2_Initialization.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="readme.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/eu_banner.png" class="logo__image only-light" alt="LISFLOOD - Río Aisén Use Case - Home"/>
    <script>document.write(`<img src="_static/eu_banner.png" class="logo__image only-dark" alt="LISFLOOD - Río Aisén Use Case - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="readme.html">
                    LISFLOOD Use Case - Río Aisén, West Patagonia, Chile
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="0_Catchment.html"><strong>0) Catchment Overview</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="1_Preprocess.html"><strong>1) Preprocessing</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="2_Initialization.html"><strong>2) Model Initialization Run</strong></a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#"><strong>3) Model Run</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="4_Calibration_MC.html"><strong>4) Monte Carlo Calibration Example</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="Excursus_Initialization.html"><strong>Excursos) Model Initialization Run</strong></a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/3_Run.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>3) Model Run</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#main-run-settings"><strong>3) Main Run Settings</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-time-series-tss">3a) Time Series (<em>.tss</em>)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#discharge"><strong>Discharge</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#snow-processes"><strong>Snow Processes</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#soil-moisture-upper-lower-zone-storages"><strong>Soil Moisture, Upper &amp; Lower Zone Storages</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#actual-evapotranspiration"><strong>Actual Evapotranspiration</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#climate-elasticity"><strong>Climate Elasticity</strong></a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <p><img alt="EU Banner" src="_images/eu_banner.png" /></p>
<section class="tex2jax_ignore mathjax_ignore" id="model-run">
<h1><strong>3) Model Run</strong><a class="headerlink" href="#model-run" title="Permalink to this heading">#</a></h1>
<hr class="docutils" />
<p>This use case intends to introduce the basic mechanics of the hydrological model <a class="reference external" href="https://github.com/ec-jrc/lisflood-code/">LISFLOOD</a>.
<br>
In this exercise, the objective is to conduct a model run read and visualize multiple time series and maps to investigate the results. <br></p>
<section id="main-run-settings">
<h2><strong>3) Main Run Settings</strong><a class="headerlink" href="#main-run-settings" title="Permalink to this heading">#</a></h2>
<p>Remember, that we had two different settings files in the <strong><code class="docutils literal notranslate"><span class="pre">/settings</span></code></strong> folder:</p>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">Settings_PreRun.xml</span></code></strong>: the settings file prepared and used for the initialization run (last exercise)</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">Settings_Run.xml</span></code></strong>: the settings file prepared and used for the actual model or calibration run (this exercise)</p></li>
</ul>
<p>We managed the initialization already in which we created the steady state inflow rates to the lower zone, and now we will utilize this information to perform the actual model run.<br>
As introduced in the last exercise, the settings differ from the initialization run!</p>
<hr class="docutils" />
<p>The main settings of the main model run in our example look:</p>
<small>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;lfoptions&gt;</span>
<span class="w">    </span>#<span class="w"> </span>[...]
<span class="w">    </span>
<span class="w">    </span>#<span class="w"> </span>INITIALIZATION<span class="w"> </span>RUN
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;TransLoss&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;MCTRouting&quot;</span><span class="nt">/&gt;</span>

<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;InitLisflood&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ColdStart&quot;</span><span class="nt">/&gt;</span>

<span class="w">    </span>#-----------------------------------------------------------
<span class="w">    </span>#<span class="w"> </span>report<span class="w"> </span>time<span class="w"> </span>series
<span class="w">    </span>#-----------------------------------------------------------
<span class="w">    </span>#<span class="w"> </span>report<span class="w"> </span>discharge<span class="w"> </span>TS
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;repDischargeTs&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;repEtactBudykoTs&quot;</span><span class="nt">/&gt;</span>

<span class="w">    </span>#<span class="w"> </span>report<span class="w"> </span>gauges<span class="w"> </span>and<span class="w"> </span>sites
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;repStateSites&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;repRateSites&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;repStateUpsGauges&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;repRateUpsGauges&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;repMeteoUpsGauges&quot;</span><span class="nt">/&gt;</span>

<span class="w">    </span>#<span class="w"> </span>report<span class="w"> </span>reservoirs<span class="w"> </span>and<span class="w"> </span>lakes
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;repsimulateLakes&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;repsimulateReservoirs&quot;</span><span class="nt">/&gt;</span>

<span class="w">    </span>#<span class="w"> </span>report<span class="w"> </span>et-related<span class="w"> </span>rates<span class="w"> </span>(do<span class="w"> </span>not<span class="w"> </span>show<span class="w"> </span>up<span class="w"> </span>via<span class="w"> </span>repRates)
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;repBal1&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span>
<span class="w">    </span>#-----------------------------------------------------------
<span class="w">    </span>#<span class="w"> </span>report<span class="w"> </span>maps
<span class="w">    </span>#-----------------------------------------------------------
<span class="w">    </span>#<span class="w"> </span>report<span class="w"> </span>state<span class="w"> </span>maps
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;repStateMaps&quot;</span><span class="nt">/&gt;</span>

<span class="w">    </span>#<span class="w"> </span>report<span class="w"> </span>end<span class="w"> </span>maps
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;repEndMaps&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;repTopSoilMoistureMaps&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;repSurfaceSoilMoistureMaps&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;repDischargeMaps&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;repSurfaceRunoffMaps&quot;</span><span class="nt">/&gt;</span>

<span class="w">    </span>#<span class="w"> </span>report<span class="w"> </span>maps
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;repRainMaps&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;repSnowMaps&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;repSnowCoverMaps&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;repSnowMeltMaps&quot;</span><span class="nt">/&gt;</span>

<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;repThetaMaps&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;repThetaForestMaps&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;repThetaIrrigationMaps&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;repLZMaps&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;repUZMaps&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;repGwPercUZLZMaps&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;repE2O1&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;repE2O2&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;setoption</span><span class="w"> </span><span class="na">choice=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;repRWS&quot;</span><span class="nt">/&gt;</span>

<span class="w">    </span>#<span class="w"> </span>[...]

<span class="nt">&lt;/lfoptions&gt;</span>

<span class="nt">&lt;lfuser&gt;</span>
<span class="w">    </span>#<span class="w"> </span>[...]

<span class="w">    </span>#<span class="w"> </span>GENERAL<span class="w"> </span>MODEL<span class="w"> </span>SETUP<span class="w"> </span>RUN
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;PathRoot&quot;</span><span class="w"> </span><span class="na">value=</span><span class="w"> </span><span class="s">&quot;./../7859_testing&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;PathInit&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;$(PathRoot)/initial&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;CalendarDayStart&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;02/01/1975 00:00&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;StepStart&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;02/01/1975 00:00&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;StepEnd&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;01/01/2024 00:00&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;timestepInit&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;1&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;DtSec&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;86400&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;DtSecChannel&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;14400&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;Gauges&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;-72.675 -45.425&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ReportSteps&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;365+365..endtime&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;NumDaysSpinUp&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;1095&quot;</span><span class="nt">&gt;</span>

<span class="w">    </span>#<span class="w"> </span>[...]

<span class="w">    </span>#<span class="w"> </span>INITIAL<span class="w"> </span>CONDITIONS
<span class="w">    </span>#<span class="w"> </span>water<span class="w"> </span>balance
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;OFDirectInitValue&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;OFOtherInitValue&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;OFForestInitValue&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;SnowCoverAInitValue&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;SnowCoverBInitValue&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;SnowCoverCInitValue&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;FrostIndexInitValue&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;CumIntInitValue&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;UZInitValue&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;$(PathOut)/uz.end.nc&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;DSLRInitValue&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>

<span class="w">    </span>#<span class="w"> </span>soil
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;LZInitValue&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;-9999&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ThetaInit1Value&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;$(PathOut)/th1.end.nc&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ThetaInit2Value&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;$(PathOut)/th2.end.nc&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ThetaInit3Value&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;$(PathOut)/th3.end.nc&quot;</span><span class="nt">&gt;</span>

<span class="w">    </span>#<span class="w"> </span>channel
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;TotalCrossSectionAreaInitValue&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;-9999&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;CrossSection2AreaInitValue&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;-9999&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;PrevSideflowInitValue&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;-9999&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;PrevDischarge&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;-9999&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;PrevDischargeAvg&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;-9999&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;PrevCmMCTInitValue&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;-9999&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;PrevDmMCTInitValue&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;-9999&quot;</span><span class="nt">&gt;</span>

<span class="w">    </span>#<span class="w"> </span>lake<span class="w"> </span>(if<span class="w"> </span>simulateLakes<span class="w"> </span>=<span class="w"> </span>1)
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;LakeInitialLevelValue&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;-9999&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;LakePrevInflowValue&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;-9999&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;LakePrevOutflowValue&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;-9999&quot;</span><span class="nt">&gt;</span>

<span class="w">    </span>#<span class="w"> </span>forest
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;CumIntForestInitValue&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;UZForestInitValue&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;$(PathOut)/uzf.end.nc&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;DSLRForestInitValue&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ThetaForestInit1Value&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;$(PathOut)/thf1.end.nc&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ThetaForestInit2Value&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;$(PathOut)/thf2.end.nc&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ThetaForestInit3Value&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;$(PathOut)/thf3.end.nc&quot;</span><span class="nt">&gt;</span>

<span class="w">    </span>#<span class="w"> </span>irrigation
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;CumIntIrrigationInitValue&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;UZIrrigationInitValue&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;DSLRIrrigationInitValue&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ThetaIrrigationInit1Value&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;$(PathOut)/thi1.end.nc&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ThetaIrrigationInit2Value&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;$(PathOut)/thi2.end.nc&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ThetaIrrigationInit3Value&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;$(PathOut)/thi3.end.nc&quot;</span><span class="nt">&gt;</span>

<span class="w">    </span>#<span class="w"> </span>impervious<span class="w"> </span>(sealed)<span class="w"> </span>areas
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;CumIntSealedInitValue&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span>#<span class="w"> </span>[...]

<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;TransLossTS&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;$(PathOut)/TransLosslong_term_run.tss&quot;</span><span class="nt">&gt;&lt;/textvar&gt;</span><span class="w">   </span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;TransLossQAvgTS&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;$(PathOut)/TransLossQAvglong_term_run.tss&quot;</span><span class="nt">&gt;&lt;/textvar&gt;</span><span class="w">      </span>

<span class="nt">&lt;/lfuser&gt;</span>

<span class="nt">&lt;lfbinding&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;LZAvInflowMap&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;$(PathInit)/lzavin&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;SeepTopToSubBAverageOtherMap&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;$(PathOut)/SeepTopToSubBAverageOtherMap&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="nt">&lt;/textvar&gt;</span><span class="w"> </span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;SeepTopToSubBAverageForestMap&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;$(PathOut)/SeepTopToSubBAverageForestMap&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="nt">&lt;/textvar&gt;</span><span class="w">    </span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;SeepTopToSubBAverageIrrigationMap&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;$(PathOut)/SeepTopToSubBAverageIrrigationMap&quot;</span><span class="nt">&gt;</span><span class="w"> </span><span class="nt">&lt;/textvar&gt;</span><span class="w">             </span>
<span class="nt">&lt;/lfbinding&gt;</span>
</pre></div>
</div>
<p>Remember, in the pre-run (or initialization run) we should have produced 16 maps that are part of the settings here as well, as we need them to properly initialize the model states.<br>
In general, you probably notice some differences in the <em>Actual Run</em> settings compared to the <em>Initialization Run</em>, which we will briefly discuss:</p>
<ul class="simple">
<li><p>The <strong><code class="docutils literal notranslate"><span class="pre">InitLisflood</span></code></strong> setting was now set to 0 as we obviously do not want to initialize LISFLOOD again.</p></li>
<li><p>The <strong><code class="docutils literal notranslate"><span class="pre">ColdStart</span></code></strong> setting was turned on (put 1).</p></li>
<li><p>We picked two flags that we recommend to use (set to 1) with respect to the considered processes:</p>
<ul>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">MCTRouting</span></code></strong> to use MCT routing</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">TransLoss</span></code></strong> to use transmission losses</p></li>
</ul>
</li>
<li><p>The <strong>report time series</strong> and <strong>report maps</strong> blocks are crucial now since we define here what outputs we want to print. Users should be aware that especially the map block can lead to a <strong>huge</strong> increase in run times and thus, it is recommended to only print whatever variables are needed.</p>
<ul>
<li><p>We printed a couple of maps and time series. For time series the <strong><code class="docutils literal notranslate"><span class="pre">...UpsGauges</span></code></strong> settings are improtant if you want to have (sub-)basin time series for the locations you specify under <strong><code class="docutils literal notranslate"><span class="pre">...Gauges</span></code></strong>. This provides aggregated time series for the (sub-)basins rather than pixel-specific time series.</p></li>
</ul>
</li>
<li><p>For the general model setup block under <strong><code class="docutils literal notranslate"><span class="pre">&lt;lfuser&gt;</span></code></strong> is almost similar to the setup in the <em>Initialization Run</em>, however, we included one special condition for <strong><code class="docutils literal notranslate"><span class="pre">ReportSteps</span></code></strong>, which provides a lot of flexibility to manage the printing of the state variables (<strong><code class="docutils literal notranslate"><span class="pre">repStateMaps</span></code></strong> ).</p>
<ul>
<li><p>The <strong><code class="docutils literal notranslate"><span class="pre">365+365..endtime</span></code></strong> value means that we are writing only the snapshoot of the state variables every 365 days, so roughly at the end of each year. However, users can write much more time steps, e.g. <strong><code class="docutils literal notranslate"><span class="pre">1..99999</span></code></strong> indicates that every time steps will be written to the state variables .nc files. More infos on that setting can be found <a class="reference external" href="https://ec-jrc.github.io/lisflood-code/3_step3_preparing-setting-file/">here</a></p></li>
</ul>
</li>
<li><p>The <strong>inital conditions block</strong> contains some changes compared to the <em>Initialization Run</em>. For example for all theta (soil moisture) variables we set the <strong><code class="docutils literal notranslate"><span class="pre">.end.nc</span></code></strong> files that were produced during the initialzation for each layer. The same applies to the Upper Zone (UZ) initialization that also take the values stored in the files produced during initialization.</p></li>
<li><p>In the <strong>bindings block</strong>, do not forget to define the paths to the average percolation and seepage maps produced in the <em>Initialization Run</em>. Please note that these maps are quite important, for instance, in our setup the <strong><code class="docutils literal notranslate"><span class="pre">.end.nc</span></code></strong> maps refer to the last time step of the <em>Initialization Run</em>, which has the same simulation period is the <em>Actual Run</em> here! Of course it would not make sense to use this one as initial value of the <em>Actual Run</em> (due to a multi-year gap), however, this value is used for the calculation of the <strong><code class="docutils literal notranslate"><span class="pre">SeepTopToSubBAverage</span></code></strong> maps.</p></li>
<li><p>Remember that the <strong><code class="docutils literal notranslate"><span class="pre">NumDaysSpinUp</span></code></strong> is only actively used in the <em>Initialization Run</em>! In the <em>Actual Run</em> it has no impact, however, in GloFAS we usually discard the Spin Up anyway from the analysis since in the <em>Actual Model Run</em>, we still have to initialise/fill the surface waters (streams, reservoirs, lakes) that might take some time, especially in the case of larger reservoirs and lakes.</p></li>
</ul>
<p>More infos can be found <a class="reference external" href="https://ec-jrc.github.io/lisflood-code/3_step6_running-LISFLOOD/">here</a>.
As this is a crucial step and understanding the settings file is one of the keys for a succesfull LISFLOOD applicatons, we encourage users to take some time to play around here and do some testing.</p>
<p>If everything is set properly in your <strong><code class="docutils literal notranslate"><span class="pre">Settings_Run.xml</span></code></strong> file then we can start running the <em>Actual Model Run</em>.
As before, open the terminal, navigate to your settings folder, activate your conda environment (which you should have done already in the initialization) where you installed LISFLOOD and run the model.
This should look as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>activate<span class="w"> </span>&lt;your_lisflood_environment&gt;
<span class="nb">cd</span><span class="w"> </span>&lt;path_where_you_saved_the_repository&gt;/settings/
lisflood<span class="w"> </span>Settings_Run.xml
</pre></div>
</div>
<p>When the run was successfull, you should have a couple of maps (.nc) and time series files (.tss) files in your <strong><code class="docutils literal notranslate"><span class="pre">$(PathOut)</span></code></strong> folder as described before.<br>
We will now check how the steady-state percolation values in this file look!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">jensenshannon</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Universally applicable Lisflood TSS Read Function</span>
<span class="k">def</span> <span class="nf">read_lisflood_tss</span><span class="p">(</span>
    <span class="n">out_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">varname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">start_date</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">n_gauges</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">skiprows</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">freq</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;D&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Robust reader for LISFLOOD .tss files with varname+runname convention.</span>
<span class="sd">    Handles small float values correctly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">run_name</span> <span class="o">=</span> <span class="n">out_dir</span><span class="o">.</span><span class="n">name</span>
    <span class="n">tss_file</span> <span class="o">=</span> <span class="n">out_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">varname</span><span class="si">}{</span><span class="n">run_name</span><span class="si">}</span><span class="s2">.tss&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">tss_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Missing LISFLOOD file → filled with NaNs: </span><span class="si">{</span><span class="n">tss_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;gauge_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_gauges</span><span class="p">)]</span>
        <span class="p">)</span>

    <span class="c1"># Read the file using whitespace delimiter for robustness</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
        <span class="n">tss_file</span><span class="p">,</span>
        <span class="n">skiprows</span><span class="o">=</span><span class="n">skiprows</span><span class="p">,</span>
        <span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">usecols</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">n_gauges</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>  <span class="c1"># only keep index + gauges</span>
        <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="nb">float</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_gauges</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)}</span>  <span class="c1"># gauge columns as float</span>
    <span class="p">)</span>

    <span class="c1"># Only keep the first n_gauges + 1 columns (date/index + gauges)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span> <span class="n">n_gauges</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Convert gauge columns to float safely</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_gauges</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">df</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># Set column names</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;gauge_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_gauges</span><span class="p">)]</span>

    <span class="c1"># Create date index</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">linregress_np</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple linear regression using numpy (equivalent to scipy.stats.linregress).</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    x : array-like</span>
<span class="sd">        Independent variable</span>
<span class="sd">    y : array-like</span>
<span class="sd">        Dependent variable</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    slope : float</span>
<span class="sd">        Slope of the regression line</span>
<span class="sd">    intercept : float</span>
<span class="sd">        Intercept of the regression line</span>
<span class="sd">    r : float</span>
<span class="sd">        Correlation coefficient (R)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Remove any NaN values</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="n">x_clean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">y_clean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">)[</span><span class="n">mask</span><span class="p">]</span>
    
    <span class="c1"># Calculate means</span>
    <span class="n">x_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x_clean</span><span class="p">)</span>
    <span class="n">y_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_clean</span><span class="p">)</span>
    
    <span class="c1"># Calculate slope and intercept</span>
    <span class="n">numerator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x_clean</span> <span class="o">-</span> <span class="n">x_mean</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_clean</span> <span class="o">-</span> <span class="n">y_mean</span><span class="p">))</span>
    <span class="n">denominator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x_clean</span> <span class="o">-</span> <span class="n">x_mean</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    
    <span class="n">slope</span> <span class="o">=</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span>
    <span class="n">intercept</span> <span class="o">=</span> <span class="n">y_mean</span> <span class="o">-</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">x_mean</span>
    
    <span class="c1"># Calculate correlation coefficient (R)</span>
    <span class="n">x_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">x_clean</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">y_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y_clean</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">numerator</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_clean</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_std</span> <span class="o">*</span> <span class="n">y_std</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r</span>
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="a-time-series-tss">
<h2>3a) Time Series (<em>.tss</em>)<a class="headerlink" href="#a-time-series-tss" title="Permalink to this heading">#</a></h2>
<p>For the time series we first load some libraries, create a function that easily reads all desired time series of the variables of interest and can be adapted accordingly.<br>
We create a dict in which we can map the files that we would like to read to whatever variable names we want.<br>
Users of course do not need to follow this approach, which is just an internal approach to handle files and variables in a structured way.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read the Upstream Area to get Basin Size</span>
<span class="n">path_model</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
<span class="n">uparea_file</span> <span class="o">=</span> <span class="s2">&quot;upArea_unclipped.nc&quot;</span>
<span class="n">outlet_file</span> <span class="o">=</span> <span class="s2">&quot;outlet.txt&quot;</span>
<span class="n">uparea</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">path_model</span> <span class="o">/</span> <span class="s2">&quot;maps&quot;</span> <span class="o">/</span> <span class="n">uparea_file</span><span class="p">)</span>
<span class="n">outlet</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_model</span> <span class="o">/</span> <span class="s2">&quot;station&quot;</span> <span class="o">/</span> <span class="n">outlet_file</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">])</span>

<span class="n">basin_area</span> <span class="o">=</span> <span class="n">uparea</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">outlet</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">lat</span><span class="o">=</span><span class="n">outlet</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span> <span class="c1"># basin size in m2</span>
<span class="n">basin_area</span> <span class="o">=</span> <span class="n">basin_area</span><span class="o">.</span><span class="n">Band1</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Start Date</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="s2">&quot;01/02/1975 00:00&quot;</span> <span class="c1"># in MM/DD/YYYY</span>

<span class="c1"># Read Data</span>
<span class="n">outfold</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;../out/long_term_run/&quot;</span>
<span class="n">run_name</span> <span class="o">=</span> <span class="s2">&quot;long_term_run&quot;</span>
<span class="n">dis_file</span> <span class="o">=</span> <span class="n">outfold</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;dis</span><span class="si">{</span><span class="n">run_name</span><span class="si">}</span><span class="s2">.tss&quot;</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dis_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

<span class="c1"># Extract number of gauges</span>
<span class="n">n_gauges</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">skiprows</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">n_gauges</span>

<span class="c1"># Obs Q</span>
<span class="c1"># obs_dis = pd.read_csv(OBS_DIR / &#39;observations.csv&#39;,parse_dates=[0])</span>
<span class="c1"># obs_dis.columns = [&quot;Date&quot;,&quot;Discharge&quot;]</span>
<span class="c1"># obs_dis = obs_dis.set_index(&quot;Date&quot;) #.drop(columns=&quot;date&quot;)</span>

<span class="c1"># Read Sim (all Vars)</span>
<span class="c1"># ETA = ESActPixel+self.var.TaPixel+self.var.TaInterceptionAll+self.var.EvaAddM3*self.var.M3toMM</span>
<span class="n">vars_to_read</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;q&quot;</span><span class="p">:</span> <span class="s2">&quot;dis&quot;</span><span class="p">,</span>
    <span class="s2">&quot;et0&quot;</span><span class="p">:</span> <span class="s2">&quot;etUps&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ew0&quot;</span><span class="p">:</span> <span class="s2">&quot;ewUps&quot;</span><span class="p">,</span> <span class="c1"># open water ref ET</span>
    <span class="s2">&quot;ewact&quot;</span><span class="p">:</span><span class="s2">&quot;evaopen&quot;</span><span class="p">,</span> <span class="c1"># open water ref ET2? -&gt; probably actual</span>
    <span class="s2">&quot;eta&quot;</span><span class="p">:</span> <span class="s2">&quot;actEvapo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;et_budy&quot;</span><span class="p">:</span> <span class="s2">&quot;actETPBUDYKOUps&quot;</span><span class="p">,</span>
    <span class="s2">&quot;es&quot;</span><span class="p">:</span> <span class="s2">&quot;esActUps&quot;</span><span class="p">,</span>
    <span class="s2">&quot;transp&quot;</span><span class="p">:</span> <span class="s2">&quot;tActUps&quot;</span><span class="p">,</span>
    <span class="s2">&quot;intcpt&quot;</span><span class="p">:</span> <span class="s2">&quot;ewIntActUps&quot;</span><span class="p">,</span>
    <span class="s2">&quot;precip&quot;</span><span class="p">:</span><span class="s2">&quot;precipUps&quot;</span><span class="p">,</span>
    <span class="s2">&quot;rain&quot;</span><span class="p">:</span> <span class="s2">&quot;rainUps&quot;</span><span class="p">,</span>
    <span class="s2">&quot;swe&quot;</span><span class="p">:</span> <span class="s2">&quot;scovUps&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sf&quot;</span><span class="p">:</span> <span class="s2">&quot;snowUps&quot;</span><span class="p">,</span>
    <span class="s2">&quot;smlt&quot;</span><span class="p">:</span> <span class="s2">&quot;snowMeltUps&quot;</span><span class="p">,</span>
    <span class="s2">&quot;total_runoff&quot;</span><span class="p">:</span> <span class="s2">&quot;totalRunoffUps&quot;</span><span class="p">,</span>
    <span class="s2">&quot;perc&quot;</span><span class="p">:</span> <span class="s2">&quot;percUZLZUps&quot;</span><span class="p">,</span>
    <span class="s2">&quot;infil&quot;</span><span class="p">:</span> <span class="s2">&quot;infUps&quot;</span><span class="p">,</span>
    <span class="s2">&quot;qb_up&quot;</span><span class="p">:</span> <span class="s2">&quot;qUzUps&quot;</span><span class="p">,</span>
    <span class="s2">&quot;qb_low&quot;</span><span class="p">:</span> <span class="s2">&quot;qLzUps&quot;</span><span class="p">,</span>
    <span class="s2">&quot;gwloss&quot;</span><span class="p">:</span> <span class="s2">&quot;gwLossUps&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lz&quot;</span><span class="p">:</span> <span class="s2">&quot;lzUps&quot;</span><span class="p">,</span>
    <span class="s2">&quot;uz&quot;</span><span class="p">:</span> <span class="s2">&quot;uzUps&quot;</span><span class="p">,</span>
    <span class="s2">&quot;theta&quot;</span><span class="p">:</span> <span class="s2">&quot;theta1total&quot;</span><span class="p">,</span>
    <span class="s2">&quot;theta2&quot;</span><span class="p">:</span> <span class="s2">&quot;theta2total&quot;</span><span class="p">,</span>
    <span class="s2">&quot;theta3&quot;</span><span class="p">:</span> <span class="s2">&quot;theta3total&quot;</span>
<span class="p">}</span>

<span class="n">lf_tss</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># Actual Read of files</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">vars_to_read</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">lf_tss</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_lisflood_tss</span><span class="p">(</span>
        <span class="n">outfold</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">n_gauges</span><span class="p">,</span> <span class="n">skiprows</span>
    <span class="p">)</span>

<span class="c1"># Print the Variables</span>
<span class="n">lf_tss</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dict_keys([&#39;q&#39;, &#39;et0&#39;, &#39;ew0&#39;, &#39;ewact&#39;, &#39;eta&#39;, &#39;et_budy&#39;, &#39;es&#39;, &#39;transp&#39;, &#39;intcpt&#39;, &#39;precip&#39;, &#39;rain&#39;, &#39;swe&#39;, &#39;sf&#39;, &#39;smlt&#39;, &#39;total_runoff&#39;, &#39;perc&#39;, &#39;infil&#39;, &#39;qb_up&#39;, &#39;qb_low&#39;, &#39;gwloss&#39;, &#39;lz&#39;, &#39;uz&#39;, &#39;theta&#39;, &#39;theta2&#39;, &#39;theta3&#39;])
</pre></div>
</div>
</div>
</div>
<p>As in our example the last day of the simulation is 1st of January 2024, which is a very incomplete year without a big benefit, we eliminate the last time step to have the last complete year (2023) as last data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get last year</span>
<span class="n">last_year</span> <span class="o">=</span> <span class="n">lf_tss</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="c1"># Drop the last year for all variables</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">lf_tss</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">lf_tss</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">lf_tss</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">lf_tss</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">!=</span> <span class="n">last_year</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed last year (</span><span class="si">{</span><span class="n">last_year</span><span class="si">}</span><span class="s2">) from all variables.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Removed last year (2024) from all variables.
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<section id="discharge">
<h3><strong>Discharge</strong><a class="headerlink" href="#discharge" title="Permalink to this heading">#</a></h3>
<p>As most hydrologists immediately wanna see how the discharge simulations of a specific run look and perform, we will start with a brief investigation of the discharge simulation results. <br>
For that, of course we have to load the actual discharge simulations to make a proper comparison!<br>
On top of that, we will calculate monthly, annual and seasonal flows for the available observations. <br></p>
<p>Note: For this exercise, we will just ignore missing (NaN) values and continue.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">file_obs</span> <span class="o">=</span> <span class="n">path_model</span> <span class="o">/</span> <span class="s2">&quot;station&quot;</span><span class="o">/</span> <span class="s2">&quot;observations.csv&quot;</span> 
<span class="n">qobs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_obs</span><span class="p">,</span><span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;qobs&quot;</span><span class="p">],</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">],</span><span class="n">dayfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">qobs</span> <span class="o">=</span> <span class="n">qobs</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span>
<span class="c1"># get rid of the timestamp</span>
<span class="n">qobs</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">qobs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
<span class="c1"># st = &quot;2000-01-01&quot;</span>
<span class="c1"># end = &quot;2016-12-31&quot;</span>
<span class="c1"># qobs = qobs.loc[st:end]</span>

<span class="c1"># Check if the data is read properly and how it looks</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">qobs</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Q (m3/s)&quot;</span><span class="p">)</span>
<span class="c1"># ax.set_xlim(qobs.index[0],qobs.index[365*3])</span>
<span class="c1"># ax.set_xlim(&quot;2012-01-01&quot;,&quot;2018-01-01&quot;)</span>

<span class="c1"># create monthly, annual, seasonal and mean day of the year time series</span>
<span class="c1"># --- Monthly time series ---</span>
<span class="n">qobs_copy</span> <span class="o">=</span> <span class="n">qobs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">qobs_copy</span> <span class="o">=</span> <span class="n">qobs_copy</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="c1"># Obs start at 31st of December 1995, so we eliminate this value to not deteriorate the monthly and annual statistics</span>
<span class="n">qobs_mon</span> <span class="o">=</span> <span class="n">qobs_copy</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># monthly mean</span>

<span class="c1"># --- Annual time series ---</span>
<span class="n">qobs_a</span> <span class="o">=</span> <span class="n">qobs_copy</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>   <span class="c1"># annual mean</span>

<span class="c1"># --- Seasonal (mean per month across all years) ---</span>
<span class="n">qobs_s</span> <span class="o">=</span> <span class="n">qobs_copy</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">qobs_copy</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">qobs_s</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Jan&quot;</span><span class="p">,</span><span class="s2">&quot;Feb&quot;</span><span class="p">,</span><span class="s2">&quot;Mar&quot;</span><span class="p">,</span><span class="s2">&quot;Apr&quot;</span><span class="p">,</span><span class="s2">&quot;May&quot;</span><span class="p">,</span><span class="s2">&quot;Jun&quot;</span><span class="p">,</span><span class="s2">&quot;Jul&quot;</span><span class="p">,</span><span class="s2">&quot;Aug&quot;</span><span class="p">,</span><span class="s2">&quot;Sep&quot;</span><span class="p">,</span><span class="s2">&quot;Oct&quot;</span><span class="p">,</span><span class="s2">&quot;Nov&quot;</span><span class="p">,</span><span class="s2">&quot;Dec&quot;</span><span class="p">]</span>

<span class="c1"># --- Mean day-of-year (average for each day-of-year across all years) ---</span>
<span class="n">qobs_doy</span> <span class="o">=</span> <span class="n">qobs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">qobs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofyear</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># Optional: if you want to set day-of-year as datetime for plotting</span>
<span class="c1"># qobs_doy.index = pd.to_datetime(qobs_doy.index, format=&#39;%j&#39;)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/d398fd4f3db306141b00df1d936ea30bd58df42a4c8638d8a1ebb17b19dc3513.png" src="_images/d398fd4f3db306141b00df1d936ea30bd58df42a4c8638d8a1ebb17b19dc3513.png" />
</div>
</div>
<p>Now let us calculate the KGE &amp; NSE for all dates with available data of the observed flows and the LISFLOOD simulations.<br>
First, we will create 3 functions for calculating NSE, KGE and an extended KGE that uses the Jensen-Shannon Difference as an additional compnent in the KGE calculation.<br>
The latter metric, called the JSD-KGE or just JDKGE, is presented here as it is used as official optimization metric in EFASv6 &amp; GloFASv5 and intends to improve the balance of high and low flows.<br>
More information can be found in the following preprint: <a class="reference external" href="https://egusphere.copernicus.org/preprints/2026/egusphere-2026-43/">https://egusphere.copernicus.org/preprints/2026/egusphere-2026-43/</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">iqr</span>

<span class="k">def</span> <span class="nf">fun_nse</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
    <span class="c1"># Align on overlapping dates</span>
    <span class="n">obs_aligned</span><span class="p">,</span> <span class="n">sim_aligned</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># Drop any NaNs</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">obs_aligned</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">sim_aligned</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
    <span class="n">obs_aligned</span> <span class="o">=</span> <span class="n">obs_aligned</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">sim_aligned</span> <span class="o">=</span> <span class="n">sim_aligned</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">sim_aligned</span> <span class="o">-</span> <span class="n">obs_aligned</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">obs_aligned</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">obs_aligned</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">fun_kge</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
    <span class="c1"># Align on overlapping dates</span>
    <span class="n">obs_aligned</span><span class="p">,</span> <span class="n">sim_aligned</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># Drop any NaNs</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">obs_aligned</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">sim_aligned</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
    <span class="n">obs_aligned</span> <span class="o">=</span> <span class="n">obs_aligned</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">sim_aligned</span> <span class="o">=</span> <span class="n">sim_aligned</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">obs_aligned</span><span class="p">,</span> <span class="n">sim_aligned</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">sim_aligned</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">obs_aligned</span><span class="p">)</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sim_aligned</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">obs_aligned</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">r</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">alpha</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">beta</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="c1">## JSD - new improved JSD - discretized version with revised (scale-invariant) binning strategy</span>
<span class="c1"># ts_s=86400 for daily time step</span>
<span class="k">def</span> <span class="nf">jsd_fd_log</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">sim</span><span class="p">,</span> <span class="n">ts_s</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Discretized Jensen-Shannon Divergence </span>
<span class="sd">    input:</span>
<span class="sd">        obs: observed</span>
<span class="sd">        sim: simulated</span>
<span class="sd">        ts_s: data time step in seconds</span>
<span class="sd">    output:</span>
<span class="sd">        js_div: Jensen-Shannon Divergence in bits (using log2 in the JSD equation)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<span class="c1"># Jensen-Shannon Divergence - log2 with bins by quantiles of concantenated data</span>

<span class="c1"># The Jensen-Shannon-Divergence measures the distance between two data distributions</span>
<span class="c1"># The JS-div falls between 1 and 0 given that one uses the base 2 logarithm (output in bits), </span>
<span class="c1"># with 0 meaning that the distributions are equal.</span>

    <span class="c1"># Fixed hyperparameters</span>
    <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-6</span>
    <span class="n">min_nbins</span> <span class="o">=</span> <span class="mi">25</span>
    <span class="n">max_nbins</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="c1"># time-step scaling factor</span>
    <span class="n">ts_factor</span> <span class="o">=</span> <span class="n">ts_s</span> <span class="o">/</span> <span class="mi">86400</span>

    <span class="c1">## non-finite and non-positive data filtering</span>
    <span class="n">obs</span> <span class="o">=</span> <span class="n">obs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">obs</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)]</span>
    <span class="n">sim</span> <span class="o">=</span> <span class="n">sim</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sim</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)]</span>

    <span class="c1"># epsilon adjustments for safety and data distribution consistency</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="n">obs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">obs_min_nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="n">obs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">obs_min_nonzero</span> <span class="o">=</span> <span class="n">epsilon</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="n">sim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sim_min_nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">sim</span><span class="p">[</span><span class="n">sim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sim_min_nonzero</span> <span class="o">=</span> <span class="n">epsilon</span>
    <span class="n">epsilon_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">obs_min_nonzero</span><span class="p">,</span> <span class="n">sim_min_nonzero</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">epsilon</span> <span class="o">&gt;</span> <span class="n">epsilon_max</span><span class="p">:</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="n">epsilon_max</span> <span class="o">*</span> <span class="mf">1e-1</span>

    <span class="n">obs</span><span class="p">[</span><span class="n">obs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">epsilon</span>
    <span class="n">sim</span><span class="p">[</span><span class="n">sim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">epsilon</span>

    <span class="c1"># log transformation</span>
    <span class="n">obs_log</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
    <span class="n">sim_log</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>

    <span class="c1"># Ensure bins are computed over the entire range of data (obs &amp; sim)</span>
    <span class="n">all_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">obs_log</span><span class="p">,</span> <span class="n">sim_log</span><span class="p">])</span>
    <span class="n">obs_log_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">all_data</span><span class="p">)</span>
    <span class="n">obs_log_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">all_data</span><span class="p">)</span>

    <span class="c1"># Freedman–Diaconis (FD) binning rule</span>
    <span class="n">iqr_val</span> <span class="o">=</span> <span class="n">iqr</span><span class="p">(</span><span class="n">obs_log</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s1">&#39;omit&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">iqr_val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">bin_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">obs_log_max</span> <span class="o">-</span> <span class="n">obs_log_min</span><span class="p">)</span> <span class="o">/</span> <span class="n">min_nbins</span> <span class="c1"># fallback bin width</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bin_width</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">iqr_val</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs_log</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># FD-based bin width</span>

    <span class="c1"># Get number of bins (FD + safety limits)</span>
    <span class="n">absolute_min_width</span> <span class="o">=</span> <span class="n">epsilon</span> <span class="o">*</span> <span class="mi">100</span>    
    <span class="n">bin_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bin_width</span><span class="p">,</span> <span class="n">absolute_min_width</span><span class="p">)</span>
    <span class="n">range_width</span> <span class="o">=</span> <span class="n">obs_log_max</span> <span class="o">-</span> <span class="n">obs_log_min</span>
    <span class="n">n_bins</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">ts_factor</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">))</span> <span class="o">*</span> <span class="n">range_width</span> <span class="o">/</span> <span class="n">bin_width</span><span class="p">)),</span> <span class="n">max_nbins</span><span class="p">),</span> <span class="n">min_nbins</span><span class="p">)</span>

    <span class="c1"># Generate bin edges </span>
    <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">obs_log_min</span><span class="p">,</span> <span class="n">obs_log_max</span><span class="p">,</span> <span class="n">n_bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  
    <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">bin_edges</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">)]</span>                  

    <span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">obs_log_min</span><span class="p">)</span>
    <span class="n">bin_edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bin_edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">obs_log_max</span><span class="p">)</span>

    <span class="c1"># Compute the histogram for observed and simulated data with density normalization</span>
    <span class="n">p_hist</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">obs_log</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">q_hist</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">sim_log</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Avoid zero probabilities by adding a small epsilon</span>
    <span class="n">p_hist</span> <span class="o">=</span> <span class="n">p_hist</span> <span class="o">+</span> <span class="n">epsilon</span>
    <span class="n">q_hist</span> <span class="o">=</span> <span class="n">q_hist</span> <span class="o">+</span> <span class="n">epsilon</span>

    <span class="c1"># Normalize histograms to ensure they represent probability distributions</span>
    <span class="n">p_hist</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">p_hist</span><span class="p">)</span>
    <span class="n">q_hist</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">q_hist</span><span class="p">)</span>
    
    <span class="c1"># Compute the mixture distribution</span>
    <span class="n">mix_hist</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_hist</span> <span class="o">+</span> <span class="n">q_hist</span><span class="p">)</span>
    
    <span class="c1"># Calculate JS divergence using base-2 logarithm</span>
    <span class="n">js_div</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">p_hist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">p_hist</span> <span class="o">/</span> <span class="n">mix_hist</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">q_hist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">q_hist</span> <span class="o">/</span> <span class="n">mix_hist</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">js_div</span>

<span class="k">def</span> <span class="nf">KGE_JSD</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">dt</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Modified Kling Gupta Efficiency with additional Jensen-Shannon Divergence component </span>
<span class="sd">	input:</span>
<span class="sd">        s: simulated</span>
<span class="sd">        o: observed</span>
<span class="sd">        dt: observations time step (in hours)</span>
<span class="sd">    output:</span>
<span class="sd">        KGE: Kling Gupta Efficiency</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span><span class="p">,</span> <span class="n">o</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Convert to NumPy</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">values</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">values</span>

    <span class="n">s</span><span class="p">,</span><span class="n">o</span> <span class="o">=</span> <span class="n">filter_nan</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">o</span><span class="p">)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">o</span><span class="p">))</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">s</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ts_s</span> <span class="o">=</span> <span class="n">dt</span><span class="o">*</span><span class="mi">3600</span>
    <span class="n">JSD</span> <span class="o">=</span> <span class="n">jsd_fd_log</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">ts_s</span><span class="p">)</span>   <span class="c1">## Jensen-Shannon Divergence</span>
    
    <span class="n">KGE_JSD</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">B</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">JSD</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">KGE_JSD</span>

<span class="k">def</span> <span class="nf">filter_nan</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">o</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    this functions removed the data  from simulated and observed data</span>
<span class="sd">    whereever the observed data contains nan</span>
<span class="sd">    </span>
<span class="sd">    this is used by all other functions, otherwise they will produce nan as </span>
<span class="sd">    output</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">o</span><span class="o">.</span><span class="n">flatten</span><span class="p">()])</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
    <span class="c1">#assert len(o) &gt; 1</span>

    <span class="c1">#mask = ~np.isnan(s) &amp; ~np.isnan(o)</span>
    <span class="c1">#o_nonan = o[mask]</span>
    <span class="c1">#s_nonan = s[mask]</span>

    <span class="c1">#return o_nonan,s_nonan</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract simulated discharge</span>
<span class="n">qsim</span> <span class="o">=</span> <span class="n">lf_tss</span><span class="p">[</span><span class="s2">&quot;q&quot;</span><span class="p">]</span>

<span class="c1"># Create a series of qobs and qsim</span>
<span class="n">qobs_series</span> <span class="o">=</span> <span class="n">qobs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># assuming qobs has one column</span>
<span class="n">qsim_series</span> <span class="o">=</span> <span class="n">qsim</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># assuming qsim has one column</span>

<span class="c1"># Get split date (when calib period starts)</span>
<span class="n">split_date</span> <span class="o">=</span> <span class="s2">&quot;1996-08-25&quot;</span> <span class="c1"># this is the date when the official GloFAS calibration period starts, so we want to evaluate only on the data after this date</span>

<span class="c1"># Subset</span>
<span class="n">qobs_20</span> <span class="o">=</span> <span class="n">qobs_series</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">split_date</span><span class="p">:]</span>
<span class="n">qsim_20</span> <span class="o">=</span> <span class="n">qsim_series</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">split_date</span><span class="p">:]</span>

<span class="c1"># Compute metrics</span>
<span class="n">nse_20</span> <span class="o">=</span> <span class="n">fun_nse</span><span class="p">(</span><span class="n">qobs_20</span><span class="p">,</span> <span class="n">qsim_20</span><span class="p">)</span>
<span class="n">kge_20</span> <span class="o">=</span> <span class="n">fun_kge</span><span class="p">(</span><span class="n">qobs_20</span><span class="p">,</span> <span class="n">qsim_20</span><span class="p">)</span>
<span class="n">kge_ext_20</span> <span class="o">=</span> <span class="n">KGE_JSD</span><span class="p">(</span><span class="n">qobs_20</span><span class="p">,</span> <span class="n">qsim_20</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NSE: </span><span class="si">{</span><span class="n">nse_20</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">KGE: </span><span class="si">{</span><span class="n">kge_20</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">KGE_ext: </span><span class="si">{</span><span class="n">kge_ext_20</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>NSE: 0.761 
KGE: 0.881 
KGE_ext: 0.880
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate the metric</span>
<span class="n">nse</span> <span class="o">=</span> <span class="n">fun_nse</span><span class="p">(</span><span class="n">qobs_series</span><span class="p">,</span><span class="n">qsim_series</span><span class="p">)</span>
<span class="n">kge</span> <span class="o">=</span> <span class="n">fun_kge</span><span class="p">(</span><span class="n">qobs_series</span><span class="p">,</span><span class="n">qsim_series</span><span class="p">)</span>
<span class="n">kge_ext</span> <span class="o">=</span> <span class="n">KGE_JSD</span><span class="p">(</span><span class="n">qobs_series</span><span class="p">,</span> <span class="n">qsim_series</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NSE: </span><span class="si">{</span><span class="n">nse</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">KGE: </span><span class="si">{</span><span class="n">kge</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">KGE_ext: </span><span class="si">{</span><span class="n">kge_ext</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>NSE: 0.764 
KGE: 0.881 
KGE_ext: 0.880
</pre></div>
</div>
</div>
</div>
<p>Okay now we have an idea of the results in terms of KGE and NSE. <br>
Let us have a look how the time series fit together visually.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">qobs</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="n">qsim</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Q (m3/s)&quot;</span><span class="p">)</span>
<span class="c1"># ax.set_xlim(qobs.index[0],qobs.index[-1])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">qobs</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">qobs</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">365</span><span class="o">*</span><span class="mi">10</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;Observed&quot;</span><span class="p">,</span><span class="s2">&quot;Simulated&quot;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/181427fde99f5f70cfa9a51ce26659c7d566262d522eb1bb25f37bc04ba6f3f7.png" src="_images/181427fde99f5f70cfa9a51ce26659c7d566262d522eb1bb25f37bc04ba6f3f7.png" />
</div>
</div>
<p>For a quick diagnostic check, we also calculate the monthly, seasonal, annual and day of the year time series of the simulated discharge.<br>
Afterwards we will plot the day of the year and annual time series of the simulation against the observation.<br>
Especially forthe day of the year time series we need to be careful to use the overlapping time period for comparability reasons.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create monthly, annual, seasonal and mean day of the year time series of the simulation</span>
<span class="c1"># --- Monthly time series ---</span>
<span class="n">qsim_mon</span> <span class="o">=</span> <span class="n">qsim</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># monthly mean</span>

<span class="c1"># --- Annual time series ---</span>
<span class="n">qsim_a</span> <span class="o">=</span> <span class="n">qsim</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>   <span class="c1"># annual mean</span>

<span class="c1"># --- Seasonal (mean per month across all years) ---</span>
<span class="n">qsim_s</span> <span class="o">=</span> <span class="n">qsim</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">qsim</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">qsim_s</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Jan&quot;</span><span class="p">,</span><span class="s2">&quot;Feb&quot;</span><span class="p">,</span><span class="s2">&quot;Mar&quot;</span><span class="p">,</span><span class="s2">&quot;Apr&quot;</span><span class="p">,</span><span class="s2">&quot;May&quot;</span><span class="p">,</span><span class="s2">&quot;Jun&quot;</span><span class="p">,</span><span class="s2">&quot;Jul&quot;</span><span class="p">,</span><span class="s2">&quot;Aug&quot;</span><span class="p">,</span><span class="s2">&quot;Sep&quot;</span><span class="p">,</span><span class="s2">&quot;Oct&quot;</span><span class="p">,</span><span class="s2">&quot;Nov&quot;</span><span class="p">,</span><span class="s2">&quot;Dec&quot;</span><span class="p">]</span>

<span class="c1"># --- Mean day-of-year (average for each day-of-year across the overlapping observation years) ---</span>
<span class="n">qsim_aligned</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">qsim</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">qobs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
<span class="n">qsim_doy</span> <span class="o">=</span> <span class="n">qsim_aligned</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">qsim_aligned</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofyear</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># Optional: if you want to set day-of-year as datetime for plotting</span>
<span class="c1"># qsim_doy.index = pd.to_datetime(qsim_doy.index, format=&#39;%j&#39;)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># --- Subplot 1: Day-of-Year / Seasonal ---</span>
<span class="n">qobs_doy</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">qsim_doy</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Mean Day-of-Year Flow&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Day of Year&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Q (m3/s)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">366</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;Observed&quot;</span><span class="p">,</span><span class="s2">&quot;Simulated&quot;</span><span class="p">]);</span>
<span class="c1"># Use a non-leap reference year to get month starts</span>
<span class="n">ref_year</span> <span class="o">=</span> <span class="mi">2001</span>
<span class="n">months</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_year</span><span class="si">}</span><span class="s2">-01-01&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_year</span><span class="si">}</span><span class="s2">-12-01&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;MS&#39;</span><span class="p">)</span>
<span class="c1"># Convert month starts to DOY</span>
<span class="n">month_positions</span> <span class="o">=</span> <span class="n">months</span><span class="o">.</span><span class="n">dayofyear</span>
<span class="n">month_labels</span> <span class="o">=</span> <span class="n">months</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%b&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">month_positions</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">month_labels</span><span class="p">)</span>

<span class="c1"># --- Subplot 2: Annual ---</span>
<span class="n">qobs_a</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">qsim_a</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Annual Flow&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Q (m3/s)&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># axes[1].set_xlim(qobs_a.index[0],qobs_a.index[-1])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;Observed&quot;</span><span class="p">,</span><span class="s2">&quot;Simulated&quot;</span><span class="p">]);</span>

<span class="c1"># Adjust layout for better spacing</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/4b2178b10af56559036c5c8ef525fcdec9f94cd2aed4fcb377e1f54c323e0bd1.png" src="_images/4b2178b10af56559036c5c8ef525fcdec9f94cd2aed4fcb377e1f54c323e0bd1.png" />
</div>
</div>
<p>Let us check how flashy the hydrograph is in general (using the Richards-Baker Flashiness Index) and what the Coefficient of Variation (CV) tells us about interannual variability.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate Coefficient of Variation (CV) for both observed and simulated annual flows</span>
<span class="n">cv_sim</span> <span class="o">=</span> <span class="n">qsim_a</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">/</span> <span class="n">qsim_a</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">cv_obs</span> <span class="o">=</span> <span class="n">qobs_a</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">/</span> <span class="n">qobs_a</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Coefficient of Variation (CV) - Simulated Annual Flows: </span><span class="si">{</span><span class="n">cv_sim</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Coefficient of Variation (CV) - Observed Annual Flows: </span><span class="si">{</span><span class="n">cv_obs</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Calculate the hydrograph flashiness using the Richards-Baker Flashiness Index (RBFI)</span>
<span class="c1"># RBFI = (sum of absolute day-to-day changes in flow) / (total</span>
<span class="n">RBFI_obs</span> <span class="o">=</span> <span class="n">qobs_series</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">qobs_series</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">RBFI_sim</span> <span class="o">=</span> <span class="n">qsim_series</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">qsim_series</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Richards-Baker Flashiness Index (RBFI) - Observed: </span><span class="si">{</span><span class="n">RBFI_obs</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Richards-Baker Flashiness Index (RBFI) - Simulated: </span><span class="si">{</span><span class="n">RBFI_sim</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Coefficient of Variation (CV) - Simulated Annual Flows: 0.130
Coefficient of Variation (CV) - Observed Annual Flows: 0.159
Richards-Baker Flashiness Index (RBFI) - Observed: 0.158
Richards-Baker Flashiness Index (RBFI) - Simulated: 0.144
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="snow-processes">
<h3><strong>Snow Processes</strong><a class="headerlink" href="#snow-processes" title="Permalink to this heading">#</a></h3>
<p>As we know already that the catchment is located in the Patagonian Andes, we can assume that the hydrology will be snow-dominated to some degree.<br>
Let us therefore have a look whether the LISFLOOD results confirm this assumption or not.<br>
We will extract snow water equivalent (SWE) and snowmelt from the LISFLOOD run, resample it to multiple temporal scales and have a detailled look.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract Snow Melt and Snow Water Equivalent from the LISFLOOD time series</span>
<span class="n">smlt</span> <span class="o">=</span> <span class="n">lf_tss</span><span class="p">[</span><span class="s2">&quot;smlt&quot;</span><span class="p">]</span>
<span class="n">swe</span> <span class="o">=</span> <span class="n">lf_tss</span><span class="p">[</span><span class="s2">&quot;swe&quot;</span><span class="p">]</span>

<span class="c1"># Resample to monthly means, annual means, seasonal means and mean day of year</span>
<span class="c1"># --- Monthly time series ---</span>
<span class="n">smlt_mon</span> <span class="o">=</span> <span class="n">smlt</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># monthly mean</span>
<span class="n">swe_mon</span> <span class="o">=</span> <span class="n">swe</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># monthly mean</span>

<span class="c1"># --- Seasonal time series ---</span>
<span class="n">smlt_s</span> <span class="o">=</span> <span class="n">smlt</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">smlt</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">swe_s</span> <span class="o">=</span> <span class="n">swe</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">swe</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">smlt_s</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Jan&quot;</span><span class="p">,</span><span class="s2">&quot;Feb&quot;</span><span class="p">,</span><span class="s2">&quot;Mar&quot;</span><span class="p">,</span><span class="s2">&quot;Apr&quot;</span><span class="p">,</span><span class="s2">&quot;May&quot;</span><span class="p">,</span><span class="s2">&quot;Jun&quot;</span><span class="p">,</span><span class="s2">&quot;Jul&quot;</span><span class="p">,</span><span class="s2">&quot;Aug&quot;</span><span class="p">,</span><span class="s2">&quot;Sep&quot;</span><span class="p">,</span><span class="s2">&quot;Oct&quot;</span><span class="p">,</span><span class="s2">&quot;Nov&quot;</span><span class="p">,</span><span class="s2">&quot;Dec&quot;</span><span class="p">]</span>
<span class="n">swe_s</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Jan&quot;</span><span class="p">,</span><span class="s2">&quot;Feb&quot;</span><span class="p">,</span><span class="s2">&quot;Mar&quot;</span><span class="p">,</span><span class="s2">&quot;Apr&quot;</span><span class="p">,</span><span class="s2">&quot;May&quot;</span><span class="p">,</span><span class="s2">&quot;Jun&quot;</span><span class="p">,</span><span class="s2">&quot;Jul&quot;</span><span class="p">,</span><span class="s2">&quot;Aug&quot;</span><span class="p">,</span><span class="s2">&quot;Sep&quot;</span><span class="p">,</span><span class="s2">&quot;Oct&quot;</span><span class="p">,</span><span class="s2">&quot;Nov&quot;</span><span class="p">,</span><span class="s2">&quot;Dec&quot;</span><span class="p">]</span>

<span class="c1"># --- Annual time series ---</span>
<span class="n">smlt_a</span> <span class="o">=</span> <span class="n">smlt</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># annual mean</span>
<span class="n">smlt_a</span> <span class="o">=</span> <span class="n">smlt_a</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># drop last year if incomplete</span>
<span class="n">swe_a</span> <span class="o">=</span> <span class="n">swe</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># annual mean</span>
<span class="n">swe_a</span> <span class="o">=</span> <span class="n">swe_a</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># drop last year if incomplete</span>

<span class="c1"># --- Annual Max time series ---</span>
<span class="n">swe_mx_a</span> <span class="o">=</span> <span class="n">swe</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>  <span class="c1"># annual mean</span>
<span class="n">swe_mx_a</span> <span class="o">=</span> <span class="n">swe_mx_a</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># drop last year if incomplete</span>

<span class="c1"># --- Day of the year time series ---</span>
<span class="n">smlt_doy</span> <span class="o">=</span> <span class="n">smlt</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">smlt</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofyear</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">swe_doy</span> <span class="o">=</span> <span class="n">swe</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">swe</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofyear</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Precalculations for the plot</span>
<span class="c1"># Ensure smlt_doy is a Series if it&#39;s a DataFrame</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>

<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">smlt_doy</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
    <span class="n">smlt_series</span> <span class="o">=</span> <span class="n">smlt_doy</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">smlt_series</span> <span class="o">=</span> <span class="n">smlt_doy</span>

<span class="c1"># Qsim in mm</span>
<span class="n">qsim_doy_mm</span> <span class="o">=</span> <span class="n">qsim_doy</span> <span class="o">/</span> <span class="n">basin_area</span> <span class="o">*</span> <span class="mf">1e3</span> <span class="o">*</span> <span class="mi">24</span><span class="o">*</span><span class="mi">3600</span>  <span class="c1"># mm/day</span>

<span class="n">total_flow</span> <span class="o">=</span> <span class="n">qsim_doy_mm</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">total_smlt</span> <span class="o">=</span> <span class="n">smlt_series</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">avg_share</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">total_smlt</span> <span class="o">/</span> <span class="n">total_flow</span>

<span class="c1"># Prepare SWE for hydrological year</span>
<span class="n">swe_plot</span> <span class="o">=</span> <span class="n">swe</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">swe_plot</span><span class="p">[</span><span class="s2">&quot;hydro_year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">swe_plot</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">+</span> <span class="p">(</span><span class="n">swe_plot</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span>

<span class="c1"># Sort to be safe</span>
<span class="n">swe_plot</span> <span class="o">=</span> <span class="n">swe_plot</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

<span class="c1"># Compute hydrological DOY by cumulative count within each hydro year</span>
<span class="n">swe_plot</span><span class="p">[</span><span class="s2">&quot;doy_hydro&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">swe_plot</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;hydro_year&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">cumcount</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
<span class="p">)</span>

<span class="c1"># Figure </span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="c1"># 1) Seasonal SWE Evolution (yearly curves)</span>
<span class="n">years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">swe_plot</span><span class="p">[</span><span class="s2">&quot;hydro_year&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;Blues&quot;</span><span class="p">)</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">years</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">years</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

<span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span>
    <span class="n">yearly</span> <span class="o">=</span> <span class="n">swe_plot</span><span class="p">[</span><span class="n">swe_plot</span><span class="p">[</span><span class="s2">&quot;hydro_year&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">year</span><span class="p">]</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">yearly</span><span class="p">[</span><span class="s2">&quot;doy_hydro&quot;</span><span class="p">],</span>
        <span class="n">yearly</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">year</span><span class="p">)),</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;SWE (mm)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Seasonal SWE Evolution&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># Monthly ticks (hydrological year Apr-Mar)</span>
<span class="n">ref_year</span> <span class="o">=</span> <span class="mi">2001</span>
<span class="n">months</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_year</span><span class="si">}</span><span class="s2">-04-01&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_year</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">-03-01&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;MS&quot;</span><span class="p">)</span>
<span class="n">month_positions</span> <span class="o">=</span> <span class="p">(</span><span class="n">months</span> <span class="o">-</span> <span class="n">months</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">days</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">month_labels</span> <span class="o">=</span> <span class="n">months</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%b&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">month_positions</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">month_labels</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">365</span><span class="p">)</span>

<span class="n">sm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
<span class="n">sm</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.02</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Hydrological Year (Southern Hemisphere)&quot;</span><span class="p">)</span>

<span class="c1"># 2) Simulated Flow + Snowmelt</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">qsim_doy_mm</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">qsim_doy_mm</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;firebrick&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Simulated Flow&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">smlt_series</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">smlt_series</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;royalblue&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Snow Melt&quot;</span><span class="p">)</span>

<span class="c1"># Fill area to visualize snowmelt contribution</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">qsim_doy_mm</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">qsim_doy_mm</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">smlt_series</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightblue&#39;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span>
<span class="p">)</span>

<span class="c1"># Monthly ticks (leap year for 366 DOY)</span>
<span class="n">ref_year</span> <span class="o">=</span> <span class="mi">2000</span>
<span class="n">months</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_year</span><span class="si">}</span><span class="s2">-01-01&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ref_year</span><span class="si">}</span><span class="s2">-12-01&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;MS&#39;</span><span class="p">)</span>
<span class="n">month_positions</span> <span class="o">=</span> <span class="n">months</span><span class="o">.</span><span class="n">dayofyear</span>
<span class="n">month_labels</span> <span class="o">=</span> <span class="n">months</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%b&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">month_positions</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">month_labels</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">366</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Discharge (mm/day)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Simulated Flow and Snow Melt&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Optional: print average snowmelt contribution</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;Avg snowmelt contribution: </span><span class="si">{</span><span class="n">avg_share</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span>
    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">),</span>
    <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span>
    <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round,pad=0.3&quot;</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># 3) Annual Maximum SWE</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">swe_mx_a</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">swe_mx_a</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;lightcoral&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Annual Max SWE&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">swe_mx_a</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">swe_mx_a</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
             <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;5-Year Smoothed&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;SWE (mm)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Year&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Annual Maximum SWE and Smoothed Trend&quot;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>  <span class="c1"># Hide the empty subplot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/98c00b2570c20e2a2eaea2b2f2efd36e0b2995df104a3894022de66667470144.png" src="_images/98c00b2570c20e2a2eaea2b2f2efd36e0b2995df104a3894022de66667470144.png" />
</div>
</div>
</section>
<hr class="docutils" />
<section id="soil-moisture-upper-lower-zone-storages">
<h3><strong>Soil Moisture, Upper &amp; Lower Zone Storages</strong><a class="headerlink" href="#soil-moisture-upper-lower-zone-storages" title="Permalink to this heading">#</a></h3>
<p>We will now have a short look at soil moisture as well as the upper and lower zone storages, e.g. to make sure that we do not have trends in the time series and to prove that the initialization worked properly.<br>
Forthis we only look at the first 10 years to see whether we can see something in the soild and groundwater that might point to any initialization error. <br>
We encourage users to also have a look at the full time series to make further hydrological investigations!</p>
<p>We also add a 30-day moving average on top of the plot to better visualize potential signals on top of the daily values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Number of days to zoom in (5 years)</span>
<span class="n">xul</span> <span class="o">=</span> <span class="mi">365</span><span class="o">*</span><span class="mi">5</span> <span class="c1"># use the numebr of years/time steps that shopuld be printed</span>

<span class="c1"># Variables to plot and their labels</span>
<span class="n">vars_to_plot</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">,</span> <span class="s2">&quot;theta2&quot;</span><span class="p">,</span> <span class="s2">&quot;theta3&quot;</span><span class="p">,</span><span class="s2">&quot;uz&quot;</span><span class="p">,</span> <span class="s2">&quot;lz&quot;</span><span class="p">]</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span>
          <span class="s2">&quot;Soil Moisture θ1 (mm3/mm3)&quot;</span><span class="p">,</span> 
          <span class="s2">&quot;Soil Moisture θ2 (mm3/mm3)&quot;</span><span class="p">,</span> 
          <span class="s2">&quot;Soil Moisture θ3 (mm3/mm3)&quot;</span><span class="p">,</span>
          <span class="s2">&quot;Upper Zone Storage (UZ) (mm)&quot;</span><span class="p">,</span> 
          <span class="s2">&quot;Lower Zone Storage (LZ) (mm)&quot;</span><span class="p">]</span>

<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="s2">&quot;purple&quot;</span><span class="p">]</span>

<span class="c1"># Create subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vars_to_plot</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vars_to_plot</span><span class="p">):</span>
    <span class="c1"># Plot raw data with faint alpha</span>
    <span class="n">lf_tss</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;_nolegend_&quot;</span><span class="p">)</span>
    
    <span class="c1"># Optionally, plot a rolling mean (e.g., 30-day moving average) for smoothing</span>
    <span class="n">lf_tss</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> 30-day MA&quot;</span><span class="p">)</span>
    
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="c1"># Zoom to first 5 years if desired</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">lf_tss</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lf_tss</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">xul</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span> 

<span class="c1"># Shared x-label for all subplots</span>
<span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

<span class="c1"># Adjust layout</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/59221edab97c53b4f18ec701bd72e34f1cf2a3e6d5e992eac96c9e34b0390a57.png" src="_images/59221edab97c53b4f18ec701bd72e34f1cf2a3e6d5e992eac96c9e34b0390a57.png" />
</div>
</div>
</section>
<hr class="docutils" />
<section id="actual-evapotranspiration">
<h3><strong>Actual Evapotranspiration</strong><a class="headerlink" href="#actual-evapotranspiration" title="Permalink to this heading">#</a></h3>
<p>Now let us check how Actual Evapotranspiration (ETA) looks in the catchment.<br>
For this we will have a look at the annual ETA sums to explore what happened during the simulation period. <br></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">eta</span> <span class="o">=</span> <span class="n">lf_tss</span><span class="p">[</span><span class="s2">&quot;eta&quot;</span><span class="p">]</span>
<span class="c1"># Annual ETA</span>
<span class="n">ws</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># moving average size in years</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">eta</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;YS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;ETA&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">eta</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;YS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">ws</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;ETA&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;ET [mm]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;ETA&quot;</span><span class="p">,</span> <span class="s2">&quot;ETA 5y average&quot;</span><span class="p">],</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/054074a7f74ed91d4cb83b9494daa0a304c35733f044540029ed7472c797f92c.png" src="_images/054074a7f74ed91d4cb83b9494daa0a304c35733f044540029ed7472c797f92c.png" />
</div>
</div>
<p>According to our longterm LISFLOOD simulation there seems to be a rise in ETA after 2010, which we will further explore. <br>
We will check whether energy-based changes, reflected as ETP, or an increase in atmospheric water availability, reflected as precipitation, or a combination and less distinct cause is responsible for the signal. <br>
Let us thus have a look at the corresponding annual anomalies with respect to a defined reference period that we set to 1980 to 2009.</p>
<p>Remember that precipitation had a significantly higher mgnitude than ETP, which is why we will use standardized anomalies.<br>
Besides, as we have seen already that the catchment is energy-limnited, the hydrologists will already have a clear tendency on the driver.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- Settings ---</span>
<span class="n">ref_start</span><span class="p">,</span> <span class="n">ref_end</span> <span class="o">=</span> <span class="s2">&quot;1980&quot;</span><span class="p">,</span> <span class="s2">&quot;2009&quot;</span>
<span class="n">ws</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># moving average window in years</span>

<span class="c1"># --- Annual sums ---</span>
<span class="n">eta_ann</span> <span class="o">=</span> <span class="n">lf_tss</span><span class="p">[</span><span class="s2">&quot;eta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;YS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">precip_ann</span> <span class="o">=</span> <span class="n">lf_tss</span><span class="p">[</span><span class="s2">&quot;precip&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;YS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">et0_ann</span> <span class="o">=</span> <span class="n">lf_tss</span><span class="p">[</span><span class="s2">&quot;et0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;YS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="c1"># --- Compute reference means ---</span>
<span class="n">eta_ref</span> <span class="o">=</span> <span class="n">eta_ann</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ref_start</span><span class="p">:</span><span class="n">ref_end</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">precip_ref</span> <span class="o">=</span> <span class="n">precip_ann</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ref_start</span><span class="p">:</span><span class="n">ref_end</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">et0_ref</span> <span class="o">=</span> <span class="n">et0_ann</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ref_start</span><span class="p">:</span><span class="n">ref_end</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># --- Compute anomalies ---</span>
<span class="n">eta_anom</span> <span class="o">=</span> <span class="n">eta_ann</span> <span class="o">-</span> <span class="n">eta_ref</span>
<span class="n">precip_anom</span> <span class="o">=</span> <span class="n">precip_ann</span> <span class="o">-</span> <span class="n">precip_ref</span>
<span class="n">et0_anom</span> <span class="o">=</span> <span class="n">et0_ann</span> <span class="o">-</span> <span class="n">et0_ref</span>

<span class="c1"># --- Normalize anomalies ---</span>
<span class="n">eta_anom_std</span> <span class="o">=</span> <span class="n">eta_anom</span> <span class="o">/</span> <span class="n">eta_anom</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">precip_anom_std</span> <span class="o">=</span> <span class="n">precip_anom</span> <span class="o">/</span> <span class="n">precip_anom</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">et0_anom_std</span> <span class="o">=</span> <span class="n">et0_anom</span> <span class="o">/</span> <span class="n">et0_anom</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

<span class="c1"># --- Smooth anomalies with moving average ---</span>
<span class="n">eta_smooth</span> <span class="o">=</span> <span class="n">eta_anom_std</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">precip_smooth</span> <span class="o">=</span> <span class="n">precip_anom_std</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">et0_smooth</span> <span class="o">=</span> <span class="n">et0_anom_std</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># --- Plot ---</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Top subplot: ETA vs Precip</span>
<span class="c1"># Raw anomalies (faint)</span>
<span class="n">eta_anom_std</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">precip_anom_std</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="c1"># Smoothed anomalies</span>
<span class="n">eta_smooth</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;ETA anomaly (5y avg)&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">precip_smooth</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Precip anomaly (5y avg)&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Standardized Anomaly&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;ETA vs Precipitation Anomalies (normalized)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;ETA anomaly&quot;</span><span class="p">,</span><span class="s2">&quot;Precip anomaly&quot;</span><span class="p">,</span><span class="s2">&quot;ETA anomaly (5y avg)&quot;</span><span class="p">,</span><span class="s2">&quot;Precip anomaly (5y avg)&quot;</span><span class="p">],</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Highlight reference period</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">ref_start</span><span class="p">,</span> <span class="n">ref_end</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="c1"># Bottom subplot: ETA vs ET0</span>
<span class="c1"># Raw anomalies (faint)</span>
<span class="n">eta_anom_std</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">et0_anom_std</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="c1"># Smoothed anomalies</span>
<span class="n">eta_smooth</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;ETA anomaly (5y avg)&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">et0_smooth</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;ET0 anomaly (5y avg)&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Standardized Anomaly&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;ETA vs ET0 Anomalies (normalized)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;ETA anomaly&quot;</span><span class="p">,</span><span class="s2">&quot;ET0 anomaly&quot;</span><span class="p">,</span><span class="s2">&quot;ETA anomaly (5y avg)&quot;</span><span class="p">,</span><span class="s2">&quot;ET0 anomaly (5y avg)&quot;</span><span class="p">],</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Highlight reference period</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">ref_start</span><span class="p">,</span> <span class="n">ref_end</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="c1"># Layout adjustments</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/6a4b25c3e93ace290534d5ec3ae114f6a857192d46b84a3090baf29ab00e471f.png" src="_images/6a4b25c3e93ace290534d5ec3ae114f6a857192d46b84a3090baf29ab00e471f.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check ET/P &amp; Q/P (Runoff Coefficient) &amp; WB Closure</span>
<span class="c1"># Annual means</span>
<span class="n">q_mm</span> <span class="o">=</span> <span class="n">lf_tss</span><span class="p">[</span><span class="s2">&quot;q&quot;</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">3600</span><span class="o">*</span><span class="mi">24</span><span class="o">/</span><span class="n">basin_area</span>
<span class="n">q_mm_ann</span> <span class="o">=</span> <span class="n">q_mm</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;YS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="n">q_p</span>   <span class="o">=</span> <span class="n">q_mm_ann</span> <span class="o">/</span> <span class="n">lf_tss</span><span class="p">[</span><span class="s2">&quot;precip&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;YS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">eta_p</span> <span class="o">=</span> <span class="n">lf_tss</span><span class="p">[</span><span class="s2">&quot;eta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;YS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">lf_tss</span><span class="p">[</span><span class="s2">&quot;precip&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;YS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">eta_et0</span> <span class="o">=</span> <span class="n">lf_tss</span><span class="p">[</span><span class="s2">&quot;eta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;YS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">lf_tss</span><span class="p">[</span><span class="s2">&quot;et0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;YS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">wb_closure</span> <span class="o">=</span> <span class="n">q_p</span> <span class="o">+</span> <span class="n">eta_p</span>
<span class="n">wb_closure_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">q_mm</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;YS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">lf_tss</span><span class="p">[</span><span class="s2">&quot;eta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;YS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">lf_tss</span><span class="p">[</span><span class="s2">&quot;precip&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;YS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Annual water balance ratios (mean ± std):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Runoff coefficient Q/P   = </span><span class="si">{</span><span class="n">q_p</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">q_p</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Evapotranspiration ETA/P = </span><span class="si">{</span><span class="n">eta_p</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">eta_p</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  ET efficiency ETA/ET0    = </span><span class="si">{</span><span class="n">eta_et0</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">eta_et0</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Check WB closure</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean water balance closure (Q/P + ETA/P) = </span><span class="si">{</span><span class="n">wb_closure</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Water balance closure at the end of the simulation = </span><span class="si">{</span><span class="n">wb_closure_end</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Annual water balance ratios (mean ± std):
  Runoff coefficient Q/P   = 0.73 ± 0.04
  Evapotranspiration ETA/P = 0.25 ± 0.03
  ET efficiency ETA/ET0    = 0.70 ± 0.02
Mean water balance closure (Q/P + ETA/P) = 0.98
Water balance closure at the end of the simulation = 0.98
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="c1"># ----------------------------</span>
<span class="c1"># Left: Annual water balance ratios over time</span>
<span class="c1"># ----------------------------</span>

<span class="c1"># Primary axis: Q/P</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">q_p</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">q_p</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Q/P&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Q/P&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Annual Water Balance Ratios&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Secondary axis: ETA/P (optional, use if scales differ)</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">eta_p</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">eta_p</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;ETA/P&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;ETA/P&quot;</span><span class="p">)</span>

<span class="c1"># Combine legends</span>
<span class="n">lines1</span><span class="p">,</span> <span class="n">labels1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
<span class="n">lines2</span><span class="p">,</span> <span class="n">labels2</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">lines1</span> <span class="o">+</span> <span class="n">lines2</span><span class="p">,</span> <span class="n">labels1</span> <span class="o">+</span> <span class="n">labels2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>

<span class="c1"># ----------------------------</span>
<span class="c1"># Right: Scatter Q/P vs ETA/P</span>
<span class="c1"># ----------------------------</span>
<span class="n">sc</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">eta_p</span><span class="p">,</span> <span class="n">q_p</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">eta_p</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;ETA / P&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Q / P&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Runoff vs Evapotranspiration Fraction&quot;</span><span class="p">)</span>

<span class="c1"># Add colorbar for year</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Year&quot;</span><span class="p">)</span>

<span class="c1"># ----------------------------</span>
<span class="c1"># Layout adjustments</span>
<span class="c1"># ----------------------------</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/2dd0a416d039e2d6046edb5b3143857d9c4e19ee07149def3a557a3148c80b45.png" src="_images/2dd0a416d039e2d6046edb5b3143857d9c4e19ee07149def3a557a3148c80b45.png" />
</div>
</div>
</section>
<hr class="docutils" />
<section id="climate-elasticity">
<h3><strong>Climate Elasticity</strong><a class="headerlink" href="#climate-elasticity" title="Permalink to this heading">#</a></h3>
<p>Finally we will examine how streamflow (Q) responds to changes in climate variables (evapotranspiration and precipitation) using climate elasticity, a widely used measure of the percentage change in runoff for a given percentage change in climate input.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- Climate Elasticity Analysis (log-log regression) ---</span>
<span class="n">ln_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">q_mm_ann</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
<span class="n">ln_et0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">et0_ann</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
<span class="n">ln_precip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">precip_ann</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

<span class="c1"># Compute elasticity (slope in log-log space)</span>
<span class="n">slope_et0</span><span class="p">,</span> <span class="n">intercept_et0</span><span class="p">,</span> <span class="n">r_et0</span> <span class="o">=</span> <span class="n">linregress_np</span><span class="p">(</span><span class="n">ln_et0</span><span class="p">,</span> <span class="n">ln_q</span><span class="p">)</span>
<span class="n">slope_precip</span><span class="p">,</span> <span class="n">intercept_precip</span><span class="p">,</span> <span class="n">r_precip</span> <span class="o">=</span> <span class="n">linregress_np</span><span class="p">(</span><span class="n">ln_precip</span><span class="p">,</span> <span class="n">ln_q</span><span class="p">)</span>

<span class="n">years</span> <span class="o">=</span> <span class="n">q_mm_ann</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># or whatever your time dimension is called</span>
<span class="n">mask_before</span> <span class="o">=</span> <span class="n">years</span> <span class="o">&lt;=</span> <span class="mi">2009</span>
<span class="n">mask_after</span> <span class="o">=</span> <span class="n">years</span> <span class="o">&gt;</span> <span class="mi">2009</span>

<span class="c1"># Create figure with two subplots for elasticity</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="c1"># --- Elasticity 1: Q vs ET0 ---</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">et0_ann</span><span class="p">[</span><span class="n">mask_before</span><span class="p">],</span> <span class="n">q_mm_ann</span><span class="p">[</span><span class="n">mask_before</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&lt;=2009&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">et0_ann</span><span class="p">[</span><span class="n">mask_after</span><span class="p">],</span> <span class="n">q_mm_ann</span><span class="p">[</span><span class="n">mask_after</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&gt;2009&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

<span class="c1"># Log-log fit line</span>
<span class="n">x_fit_et0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ln_et0</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">ln_et0</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">y_fit_et0</span> <span class="o">=</span> <span class="n">slope_et0</span> <span class="o">*</span> <span class="n">x_fit_et0</span> <span class="o">+</span> <span class="n">intercept_et0</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x_fit_et0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">y_fit_et0</span><span class="p">),</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Elasticity = </span><span class="si">{</span><span class="n">slope_et0</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> (R²=</span><span class="si">{</span><span class="n">r_et0</span><span class="o">**</span><span class="mi">2</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;ET0 (mm/year)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Q (mm/year)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Q vs ET0 - Elasticity = </span><span class="si">{</span><span class="n">slope_et0</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># --- Elasticity 2: Q vs Precipitation ---</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">precip_ann</span><span class="p">[</span><span class="n">mask_before</span><span class="p">],</span> <span class="n">q_mm_ann</span><span class="p">[</span><span class="n">mask_before</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&lt;=2009&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">precip_ann</span><span class="p">[</span><span class="n">mask_after</span><span class="p">],</span> <span class="n">q_mm_ann</span><span class="p">[</span><span class="n">mask_after</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&gt;2009&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

<span class="c1"># Log-log fit line</span>
<span class="n">x_fit_precip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ln_precip</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">ln_precip</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">y_fit_precip</span> <span class="o">=</span> <span class="n">slope_precip</span> <span class="o">*</span> <span class="n">x_fit_precip</span> <span class="o">+</span> <span class="n">intercept_precip</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x_fit_precip</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">y_fit_precip</span><span class="p">),</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Elasticity = </span><span class="si">{</span><span class="n">slope_precip</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> (R²=</span><span class="si">{</span><span class="n">r_precip</span><span class="o">**</span><span class="mi">2</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Precipitation (mm/year)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Q (mm/year)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Q vs Precipitation - Elasticity = </span><span class="si">{</span><span class="n">slope_precip</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># --- Print Elasticity Summary ---</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CLIMATE ELASTICITY ANALYSIS&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Q vs ET0 (Evapotranspiration):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Elasticity (slope): </span><span class="si">{</span><span class="n">slope_et0</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  R²: </span><span class="si">{</span><span class="n">r_et0</span><span class="o">**</span><span class="mi">2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Interpretation: A 1% increase in ET0 leads to </span><span class="si">{</span><span class="n">slope_et0</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% change in Q&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Q vs Precipitation:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Elasticity (slope): </span><span class="si">{</span><span class="n">slope_precip</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  R²: </span><span class="si">{</span><span class="n">r_precip</span><span class="o">**</span><span class="mi">2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Interpretation: A 1% increase in Precip leads to </span><span class="si">{</span><span class="n">slope_precip</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% change in Q&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/cbc205ea3b96aa55f218a74d6104871836df1be2178b9ad863105583205ccc6e.png" src="_images/cbc205ea3b96aa55f218a74d6104871836df1be2178b9ad863105583205ccc6e.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>============================================================
CLIMATE ELASTICITY ANALYSIS
============================================================

Q vs ET0 (Evapotranspiration):
  Elasticity (slope): -1.3181
  R²: 0.1674
  Interpretation: A 1% increase in ET0 leads to -1.32% change in Q

Q vs Precipitation:
  Elasticity (slope): 1.0393
  R²: 0.8409
  Interpretation: A 1% increase in Precip leads to 1.04% change in Q
============================================================
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="2_Initialization.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><strong>2) Model Initialization Run</strong></p>
      </div>
    </a>
    <a class="right-next"
       href="4_Calibration_MC.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><strong>4) Monte Carlo Calibration Example</strong></p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#main-run-settings"><strong>3) Main Run Settings</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-time-series-tss">3a) Time Series (<em>.tss</em>)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#discharge"><strong>Discharge</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#snow-processes"><strong>Snow Processes</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#soil-moisture-upper-lower-zone-storages"><strong>Soil Moisture, Upper &amp; Lower Zone Storages</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#actual-evapotranspiration"><strong>Actual Evapotranspiration</strong></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#climate-elasticity"><strong>Climate Elasticity</strong></a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Joint Research Center - European Commission
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2026.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>